(()=>{var e;function t(){var e={title:"Chat",theme:{primary:"#0078d4",userBubble:"#e6f0fa",botBubble:"#f1f1f1",userText:"#22223b",botText:"#4a4e69",background:"#fff",border:"#ccc",text:"#222",width:"100%",maxWidth:"350px",minWidth:"220px",borderRadius:"8px",fontFamily:"sans-serif",zIndex:9999,headerText:"#fff",headerBg:"rgba(34, 34, 59, 0.95)",inputBg:"#fff",inputText:"#222",sendBtnBg:"#0078d4",sendBtnText:"#fff",sendBtnHover:"#005fa3",shadow:"0 2px 8px rgba(0,0,0,0.15)",salesRepBubble:"#f1f5f9",salesRepText:"#475569",salesRepAvatar:"#E4E7FC",userAvatar:"#8349ff",botAvatar:"#E4E7FC",handoverNotificationBg:"#E4E7FC",handoverNotificationText:"#334155",handoverNotificationBorder:"#8349FF"}},T=window.SimpleChatEmbedConfig?{...e,...window.SimpleChatEmbedConfig,theme:{...e.theme,...window.SimpleChatEmbedConfig.theme||{}}}:e,I=T.theme,s=T.welcomeMessage||null,O=T.workflowId,W=T.socketUrl+"/ws/app/",M=void 0===T.leadCapture||T.leadCapture,a=null,i=null,r=!1,m=null,g=!1,L=!1,d=null,R=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent);function z(){L?(l.style.opacity="0.5",l.style.cursor="not-allowed",o.style.opacity="0.5",o.style.cursor="not-allowed"):(l.style.opacity="1",l.style.cursor="pointer",o.style.opacity="1",o.style.cursor="pointer")}function F(e){let t=btoa(String(e));var e=new TextEncoder,n=e.encode("4f3c9a1d8e5b6c2f719a0e3d5a8b7c4d9e6f1a0b3d7c8e2f6a9d0e1b4c5f7a6d");let s=e.encode(t);return window.crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then(e=>window.crypto.subtle.sign("HMAC",e,s)).then(e=>{e=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("");return{hashed_workflow_id:t,hash:e}})}function j(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}var t=document.createElement("div");function D(){window.innerWidth<768?(t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.right="0",t.style.bottom="0",t.style.width="100%",t.style.height="100dvh",t.style.borderRadius="0",t.style.maxHeight="100dvh"):(t.style.position="fixed",t.style.top="auto","left"===T.position?(t.style.left="20px",t.style.right="auto"):(t.style.left="auto",t.style.right="20px"),t.style.bottom="20px",t.style.width="384px",t.style.height="80vh",t.style.borderRadius="12px",t.style.maxHeight="600px"),t.style.overflow="hidden"}t.id="simple-chat-embed",t.style.position="fixed",t.style.bottom="20px","left"===T.position?(t.style.left="20px",t.style.right="auto"):(t.style.right="20px",t.style.left="auto"),t.style.width="384px",t.style.height="80vh",t.style.maxHeight="600px",t.style.background="#ffffff",t.style.border="1px solid #e2e8f0",t.style.borderRadius="12px",t.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",t.style.fontFamily=I.fontFamily+", Inter, system-ui, sans-serif",t.style.zIndex=I.zIndex,t.style.color=I.text,t.style.transition="transform 0.3s ease-in-out",t.style.display="flex",t.style.flexDirection="column",t.style.overflow="hidden",D(),window.addEventListener("resize",D);var J=window.innerHeight;function Z(){var e;R&&window.innerWidth<768&&(e=window.innerHeight,100<J-e?(t.style.height=e+"px",t.style.maxHeight=e+"px",setTimeout(function(){y.scrollIntoView({behavior:"smooth",block:"end"})},100)):(t.style.height="100vh",t.style.height="100dvh",t.style.maxHeight="100vh",t.style.maxHeight="100dvh"))}window.addEventListener("resize",Z),window.visualViewport&&window.visualViewport.addEventListener("resize",Z);var e=document.createElement("div"),n=(e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.background=I.headerBg||"#16a34a",e.style.color=I.headerText,e.style.padding="32px",e.style.borderTopLeftRadius="12px",e.style.borderTopRightRadius="12px",e.style.fontWeight="600",e.style.fontSize="18px",e.style.lineHeight="28px",e.style.position="sticky",e.style.top="0",e.style.top="0",document.createElement("div")),n=(n.innerText=T.title,e.appendChild(n),document.createElement("div")),l=(n.style.display="flex",n.style.gap="4px",document.createElement("button")),o=(l.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="m21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>',l.title="Clear chat history",l.style.background="transparent",l.style.color=I.headerText,l.style.border="none",l.style.padding="8px",l.style.cursor="pointer",l.style.borderRadius="6px",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.transition="background-color 0.2s ease-in-out",l.onmouseover=function(){L||(l.style.backgroundColor="rgba(255,255,255,0.1)")},l.onmouseout=function(){l.style.backgroundColor="transparent"},l.onclick=function(){if(!L){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]").some(function(e){return e.isSystemNotification&&"joined"===e.notificationType}),t=localStorage.getItem("simple-chat-session"),n=!1;if(t)try{n=!0===JSON.parse(t).handoverOccurred}catch(e){console.log("Error reading session handover flag:",e)}localStorage.removeItem("simple-chat-messages"),g=!(!e&&!n),E(),s&&k(s,"bot","welcomeMessage"),v()}},document.createElement("button")),c=(o.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>',o.title="Clear session & restart",o.style.background="transparent",o.style.color=I.headerText,o.style.border="none",o.style.padding="8px",o.style.cursor="pointer",o.style.borderRadius="6px",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.transition="background-color 0.2s ease-in-out",o.onmouseover=function(){L||(o.style.backgroundColor="rgba(255,255,255,0.1)")},o.onmouseout=function(){o.style.backgroundColor="transparent"},o.onclick=function(){L||(localStorage.removeItem("simple-chat-messages"),localStorage.removeItem("simple-chat-session"),localStorage.removeItem("simple-chat-leads"),localStorage.removeItem("simple-chat-user-guid"),L=g=!1,window.__simpleChatEmbedLeadCaptured=!1,m=null,a&&(a.close(),a=null,r=!1),H.innerHTML="",M?(y.style.display="none",q(function(e){L=!1,z(),window.__simpleChatEmbedLeadCaptured=!0,e&&(window.SimpleChatEmbedLead=e),E(),s&&k(s,"bot","welcomeMessage"),v()})):(window.__simpleChatEmbedLeadCaptured=!0,E(),A(null,null,null,null).then(()=>{s&&k(s,"bot","welcomeMessage"),v(),C()}).catch(e=>{console.error("Failed to create anonymous visitor:",e),s&&k(s,"bot","welcomeMessage"),v(),C()})))},document.createElement("button")),P=(c.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',c.title="Close chat",c.style.background="transparent",c.style.color=I.headerText,c.style.border="none",c.style.padding="8px",c.style.cursor="pointer",c.style.borderRadius="6px",c.style.display="flex",c.style.alignItems="center",c.style.justifyContent="center",c.style.transition="background-color 0.2s ease-in-out",c.onmouseover=function(){c.style.backgroundColor="rgba(255,255,255,0.1)"},c.onmouseout=function(){c.style.backgroundColor="transparent"},c),H=(n.appendChild(l),n.appendChild(o),n.appendChild(c),e.appendChild(n),t.appendChild(e),document.createElement("div")),n=(H.style.flex="1 1 0%",H.style.minHeight="0",H.style.overflowY="auto",H.style.overflowX="hidden",H.style.padding="0",H.style.background="#ffffff",H.style.webkitOverflowScrolling="touch",H.id="chat-messages",H.style.display="flex",H.style.flexDirection="column",H.style.gap="0",H.style.scrollBehavior="smooth",H.style.scrollbarWidth="none",H.style.msOverflowStyle="none",document.createElement("style")),p=(n.textContent=`
        #chat-messages::-webkit-scrollbar { display: none; }
        #simple-chat-embed ul { list-style-type: disc !important; }
        #simple-chat-embed ol { list-style-type: decimal !important; }
        #simple-chat-embed ul li::marker { color: #6b7280; }
        #simple-chat-embed ol li::marker { color: #6b7280; font-weight: 600; }
        #simple-chat-embed pre { white-space: pre-wrap; word-wrap: break-word; }
        #simple-chat-embed code { word-wrap: break-word; }
        #simple-chat-embed blockquote { 
            border-left: 4px solid #e5e7eb; 
            padding-left: 16px; 
            margin: 16px 0; 
            color: #6b7280; 
            font-style: italic; 
        }
   @media (max-width: 767px) {
            #simple-chat-embed input,
            #simple-chat-embed textarea,
            #simple-chat-embed button {
                font-size: 16px !important; /* Prevents zoom on iOS */
                -webkit-appearance: none;
                appearance: none;
            }
        }
    `,document.head.appendChild(n),t.appendChild(H),document.createElement("button")),y=(p.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 13 5 5 5-5"/><path d="M12 18V6"/></svg>',p.title="Scroll to bottom",p.style.position="absolute",p.style.right="16px",p.style.bottom="80px",p.style.width="40px",p.style.height="40px",p.style.borderRadius="50%",p.style.background=I.sendBtnBg||"#3b82f6",p.style.color="#ffffff",p.style.border="none",p.style.cursor="pointer",p.style.display="none",p.style.alignItems="center",p.style.justifyContent="center",p.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",p.style.transition="all 0.3s ease",p.style.zIndex="10",p.addEventListener("mouseover",function(){p.style.backgroundColor=I.sendBtnHover||"#2563eb",p.style.transform="scale(1.1)"}),p.addEventListener("mouseout",function(){p.style.backgroundColor=I.sendBtnBg||"#3b82f6",p.style.transform="scale(1)"}),p.onclick=function(){H.scrollTop=H.scrollHeight,p.style.display="none"},t.appendChild(p),document.createElement("div")),u=(y.style.padding="16px",y.style.background="#ffffff",y.style.display="flex",y.style.flexDirection="column",y.style.borderBottomLeftRadius="12px",y.style.borderBottomRightRadius="12px",document.createElement("div")),f=(u.style.display="none",u.style.flexDirection="column",u.style.gap="8px",u.style.marginBottom="16px",u.style.width="100%",T.quickQuestions&&0<T.quickQuestions.length&&T.quickQuestions.forEach(function(e,t){var n=document.createElement("button");n.innerText=e,n.style.padding="12px 16px",n.style.background="#f3f4f6",n.style.color="#374151",n.style.border="1px solid #d1d5db",n.style.borderRadius="8px",n.style.cursor="pointer",n.style.fontSize="14px",n.style.transition="all 0.2s ease-in-out",n.style.width="100%",n.style.textAlign="left",n.style.boxSizing="border-box",n.addEventListener("mouseover",function(){n.style.background=I.sendBtnBg||"#3b82f6",n.style.color="#ffffff",n.style.borderColor=I.sendBtnBg||"#3b82f6"}),n.addEventListener("mouseout",function(){n.style.background="#f3f4f6",n.style.color="#374151",n.style.borderColor="#d1d5db"}),n.addEventListener("click",function(){h.value=e,_(),T.quickQuestionsPermanent||(u.style.display="none")}),u.appendChild(n)}),y.appendChild(u),t.appendChild(y),document.createElement("div")),h=(f.style.display="grid",f.style.gridTemplateColumns="1fr auto",f.style.gap="16px",f.style.alignItems="center",f.style.width="100%",document.createElement("input")),x=(h.type="text",h.placeholder="Type your message...",h.style.padding="12px 16px",h.style.border="1px solid #d1d5db",h.style.borderRadius="6px",h.style.background="#ffffff",h.style.color="#374151",h.style.fontSize="14px",h.style.lineHeight="20px",h.style.outline="none",h.style.transition="border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out",h.style.fontFamily="sans-serif",h.addEventListener("focus",function(){h.style.borderColor="#3b82f6",h.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.1)"}),h.addEventListener("blur",function(){h.style.borderColor="#d1d5db",h.style.boxShadow="none"}),document.createElement("button"));function b(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function v(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");H.innerHTML="",e.some(function(e){return e.isSystemNotification&&"joined"===e.notificationType})&&(g=!0);for(var t,n=0;n<e.length;n++){var s,l,o,a,i,r,d,c,p,y,m,u=e[n];u.isSystemNotification?((o=document.createElement("div")).style.display="flex",o.style.justifyContent="center",o.style.margin="16px 0",o.style.animation="fadeInUp 0.5s ease-out",l=((s=document.createElement("div")).style.background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",s.style.color="#ffffff",s.style.padding="12px 24px",s.style.borderRadius="20px",s.style.fontSize="14px",s.style.fontWeight="500",s.style.display="flex",s.style.alignItems="center",s.style.gap="8px",s.style.maxWidth="80%",s.style.textAlign="center",document.createElement("span")),"joined"===u.notificationType?(l.innerHTML="ðŸ‘‹",s.style.background=I.handoverNotificationBg||"#E4E7FC",s.style.color=I.handoverNotificationText||"#334155",s.style.border="1px solid "+(I.handoverNotificationBorder||"#8349FF")):l.innerHTML="ðŸ’¬",l.style.fontSize="16px",s.appendChild(l),s.appendChild(document.createTextNode(u.text)),o.appendChild(s),document.getElementById("system-notification-style")||((l=document.createElement("style")).id="system-notification-style",l.innerHTML=`
                        @keyframes fadeInUp {
                            0% { opacity: 0; transform: translateY(20px); }
                            100% { opacity: 1; transform: translateY(0); }
                        }
                    `,document.head.appendChild(l)),H.appendChild(o)):((s=document.createElement("div")).style.display="flex",s.style.flexDirection="column",s.style.marginBottom="16px",o=((l=document.createElement("div")).style.display="flex",l.style.gap="8px","user"===u.sender&&(l.style.flexDirection="row-reverse",l.style.justifyContent="flex-start"),null),"user"===u.sender?((o=document.createElement("div")).style.width="40px",o.style.height="40px",o.style.borderRadius="50%",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.background=I.userAvatar||"#8349ff",(a=document.createElement("div")).innerHTML=`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21V19C19 17.9391 18.5786 16.9217 17.8284 16.1716C17.0783 15.4214 16.0609 15 15 15H9C7.93913 15 6.92172 15.4214 6.17157 16.1716C5.42143 16.9217 5 17.9391 5 19V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `,o.appendChild(a)):"sales_rep"===u.sender?((o=document.createElement("div")).style.width="40px",o.style.height="40px",o.style.borderRadius="50%",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.background=I.salesRepAvatar||"#E4E7FC",i=I.primary||"#8349FF",o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" style="width:26px;height:26px;color:'+i+';" width="200" height="200" viewBox="0 0 24 24"><path fill="currentColor" d="M19.938 8H21a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1.062A8.001 8.001 0 0 1 12 23v-2a6 6 0 0 0 6-6V9A6 6 0 0 0 6 9v7H3a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1.062a8.001 8.001 0 0 1 15.876 0ZM3 10v4h1v-4H3Zm17 0v4h1v-4h-1ZM7.76 15.785l1.06-1.696A5.972 5.972 0 0 0 12 15a5.972 5.972 0 0 0 3.18-.911l1.06 1.696A7.963 7.963 0 0 1 12 17a7.962 7.962 0 0 1-4.24-1.215Z"/></svg>'):"bot"!==u.sender&&"ai"!==u.sender||((o=document.createElement("div")).style.width="40px",o.style.height="40px",o.style.borderRadius="50%",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.background=I.botAvatar||"#E4E7FC",a=document.createElement("div"),i=I.primary||"#8349ff",a.innerHTML=`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_4_4929)">
                            <path d="M19 11H5C3.89543 11 3 11.8954 3 13V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V13C21 11.8954 20.1046 11 19 11Z" stroke="${i}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 7C13.1046 7 14 6.10457 14 5C14 3.89543 13.1046 3 12 3C10.8954 3 10 3.89543 10 5C10 6.10457 10.8954 7 12 7Z" stroke="${i}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 7V11" stroke="${i}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                        <defs>
                            <clipPath id="clip0_4_4929">
                                <rect width="24" height="24" fill="white"/>
                            </clipPath>
                        </defs>
                    </svg>
                `,o.appendChild(a)),(r=document.createElement("div")).style.display="flex",r.style.flexDirection="column",r.style.gap="8px",r.style.maxWidth=(u.sender,"70%"),(d=document.createElement("div")).style.padding="12px 16px",d.style.wordBreak="break-word",d.style.fontSize="14px",d.style.lineHeight="20px",d.style.position="relative","user"===u.sender?(d.style.backgroundColor=I.userBubble||"#dbeafe",d.style.color=I.userText||"#1e40af",d.style.alignSelf="flex-end",d.style.borderRadius="16px 16px 4px 16px",d.style.boxShadow="0 2px 8px rgba(59, 130, 246, 0.15)"):"sales_rep"===u.sender?(d.style.background=I.salesRepBubble||"#f1f5f9",d.style.color=I.salesRepText||"#475569",d.style.alignSelf="flex-start",d.style.borderRadius="16px 16px 16px 4px"):(d.style.backgroundColor=I.botBubble||"#f1f5f9",d.style.color=I.botText||"#475569",d.style.alignSelf="flex-start",d.style.borderRadius="16px 16px 16px 4px",d.style.boxShadow="0 2px 8px rgba(71, 85, 105, 0.1)"),""===u.text&&n===e.length-1?d.appendChild((t=c=void 0,(c=document.createElement("span")).style.display="inline-flex",c.style.alignItems="center",c.style.height="1.5em",t=I.botText||"#4a4e69",c.innerHTML=`
      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s infinite alternate;"></span>
      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.2s infinite alternate;"></span>
      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.4s infinite alternate;"></span>
    `,document.getElementById("simple-chat-bounce-style")||((t=document.createElement("style")).id="simple-chat-bounce-style",t.innerHTML="@keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-7px); } }",document.head.appendChild(t)),c)):"[Image]"===u.text&&0<n&&"string"==typeof(t=e[n-1].text)&&t.startsWith("data:image/")?((c=document.createElement("img")).src=e[n-1].text,c.style.maxWidth="200px",c.style.maxHeight="150px",c.style.borderRadius="8px",c.style.display="block",d.appendChild(c)):(p=document.createElement("div"),"bot"===u.sender||"ai"===u.sender?p.innerHTML=(t=>{if(!t)return"";try{if("undefined"==typeof marked)throw new Error("marked.js not available");var e=marked.parse(t,{breaks:!0,gfm:!0});return"string"==typeof e?e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/<p>/g,'<p style="font-size:inherit;line-height:inherit;font-family:inherit;font-weight:inherit;margin:0;">')).replace(/<a\s+href="([^"]*)"([^>]*)>([^<]*)<\/a>/g,function(e,t,n,s){return'<a href="'+t+'" target="_blank" style="font-weight:bold;color:'+(I.botText||"#4a4e69")+';text-decoration:underline;cursor:pointer;">'+s+"</a>"})).replace(/<ul>/g,'<ul style="margin:8px 0;padding-left:24px;">')).replace(/<ol>/g,'<ol style="margin:8px 0;padding-left:24px;">')).replace(/<li>/g,'<li style="margin:4px 0;">')).replace(/<pre><code>/g,"<pre style=\"background:#f6f8fa;border:1px solid #e1e4e8;border-radius:6px;padding:16px;margin:8px 0;overflow-x:auto;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:13px;line-height:1.45;\"><code>")).replace(/<code>/g,"<code style=\"background:#f6f8fa;border-radius:3px;padding:2px 4px;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:85%;\">")).replace(/<strong>/g,'<strong style="font-weight:600;">')).replace(/<em>/g,'<em style="font-style:italic;">'):String(e)}catch(e){return console.error("Markdown parsing error:",e),b(t).replace(/\n/g,"<br>")}})(u.text):"sales_rep"===u.sender?(y=b(u.text).replace(/\n/g,"<br>"),m="Sales Representative",u.senderName&&("string"==typeof u.senderName?m=u.senderName:u.senderName.name&&(m=u.senderName.name)),p.innerHTML='<div style=" padding-bottom: 6px; font-size: 12px; color: #6b7280; font-weight: 500;">~ '+m+"</div>"+y,p.style.fontWeight="500",p.style.lineHeight="1.4",p.style.display="block",p.style.width="100%"):p.innerHTML=b(u.text).replace(/\n/g,"<br>"),d.appendChild(p)),r.appendChild(d),u.isWelcomeMessage||((m=document.createElement("div")).style.fontSize="12px",m.style.color="#9ca3af",m.style.alignSelf="user"===u.sender?"flex-end":"flex-start",m.innerText=u.created_at,r.appendChild(m)),o&&l.appendChild(o),l.appendChild(r),s.appendChild(l),H.appendChild(s))}H.scrollTop=H.scrollHeight,setTimeout(function(){H.scrollTop=H.scrollHeight,w()},100)}function w(){var e=H.scrollHeight-H.scrollTop<=H.clientHeight+100;p.style.display=e?"none":"flex"}function $(){var t=0;!function e(){H.scrollTop=H.scrollHeight,++t<5&&H.scrollTop<H.scrollHeight-H.clientHeight-10?setTimeout(e,50):w()}()}function k(e,t,n=""){var s=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");"welcomeMessage"===n?-1!==(n=s.findIndex(e=>e.isWelcomeMessage))?s[n].text=e:s.push({text:e,isWelcomeMessage:!0,sender:t}):s.push({text:e,isWelcomeMessage:!1,sender:t,created_at:S((new Date).toISOString())}),localStorage.setItem("simple-chat-messages",JSON.stringify(s))}async function C(){if(!r&&!a){var e,t,n=localStorage.getItem("simple-chat-session");if(n)try{var s=JSON.parse(n),l=new Date-new Date(s.timestamp),o=s.chatID&&s.workflowId&&s.hashedWorkflowId&&s.hash&&l<864e5;if(!(o=M?o&&s.visitorInfo:o))throw new Error("Invalid or expired session");d=s.chatID,e=s.workflowId,t={hashed_workflow_id:s.hashedWorkflowId,hash:s.hash},s.visitorInfo&&(m=s.visitorInfo)}catch(e){console.log("Invalid session data, generating new session"),localStorage.removeItem("simple-chat-session"),n=null}n||(d=j(),t=await F(e=O),l={chatID:d,workflowId:e,hashedWorkflowId:t.hashed_workflow_id,hash:t.hash,timestamp:(new Date).toISOString()},M&&m&&(l.visitorInfo=m),localStorage.setItem("simple-chat-session",JSON.stringify(l)));o=""+W+T.org_id+"/?visitor_info="+JSON.stringify(m);try{(a=new WebSocket(o)).onopen=function(){if(r=!0,a.readyState===WebSocket.OPEN){let e={message_type:"heartbeat",timestamp:Date.now()};i=setInterval(function(){a.send(JSON.stringify(e))},2500)}},a.onmessage=function(e){e=JSON.parse(e.data);if(e?.room_name&&e?.room_name===d){if("unread_message"===e?.message_type)return;if("handover_requested"===e?.message_type)return;if("handover_message"===e?.message_type){g=!0;var t=localStorage.getItem("simple-chat-session");if(t)try{var n=JSON.parse(t);n.handoverOccurred=!0,localStorage.setItem("simple-chat-session",JSON.stringify(n))}catch(e){console.log("Error updating session with handover flag:",e)}return(t=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:e.sender?.name+" has entered the chat",sender:"system",isWelcomeMessage:!1,isSystemNotification:!0,notificationType:"joined",created_at:S(e.created_at||(new Date).toISOString())}),localStorage.setItem("simple-chat-messages",JSON.stringify(t)),void v()}if("ai"!==e.sender_type&&"ai"!==e.sender&&"bot"!==e.sender_type&&"bot"!==e.sender||g){if("sales_rep"===e.sender_type||"sales_rep"===e.sender){if(!(s=e.content||"")||!s.trim())return;(t=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:s,sender:e.sender_type,senderName:e.sender||e.sender_name||"Sales Representative",isWelcomeMessage:!1,created_at:S(e.created_at)}),localStorage.setItem("simple-chat-messages",JSON.stringify(t)),v()}}else{var n=(t=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"))[t.length-1],s=(!n||""!==n.text||"bot"!==n.sender&&"ai"!==n.sender||(t.pop(),n=t[t.length-1]||null),e.content||e.message||"");if(!0===e.is_complete&&""===s)return void(n&&n.isStreaming&&(console.log("Stream completed"),n.isStreaming=!1,t[t.length-1]=n,localStorage.setItem("simple-chat-messages",JSON.stringify(t))));s&&(!n||"bot"!==n.sender&&"ai"!==n.sender||!0!==n.isStreaming?t.push({text:s,sender:"bot",isWelcomeMessage:!1,isStreaming:!0,messageId:e.message_id,created_at:S(e.created_at),lastChunkTime:Date.now()}):(n.text+=s,n.lastChunkTime=Date.now(),t[t.length-1]=n),localStorage.setItem("simple-chat-messages",JSON.stringify(t)),v())}}},a.onclose=function(){console.error("WebSocket connection closed unexpectedly..."),r=!1,a=null,i&&clearInterval(i),i=null},a.onerror=function(e){console.error("WebSocket error:",e),r=!1,a=null,i&&clearInterval(i),i=null}}catch(e){console.error("Failed to create WebSocket connection:",e),r=!1,a=null,i&&clearInterval(i),i=null}}}function S(e){return new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0})}function _(t){var n=h.value.trim()||t;if(n)if(k(n,"user"),h.value="",v(),g||(k("","bot"),v()),r&&a&&a.readyState===WebSocket.OPEN)try{a.send(JSON.stringify({message:n,message_type:"text",room_name:d}))}catch(e){console.error("Error sending message:",e);t=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");0<t.length&&""===t[t.length-1].text&&t.pop(),t.push({text:"Error sending message. Please try again.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(t)),v()}else{C();var s=function(){var e;a&&a.readyState===WebSocket.OPEN?a.send(JSON.stringify({message:n,message_type:"text",room_name:d})):a&&a.readyState===WebSocket.CONNECTING?setTimeout(s,100):(0<(e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).length&&""===e[e.length-1].text&&e.pop(),e.push({text:"Error: Could not connect to chat service.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(e)),v())};setTimeout(s,500)}}function q(a){L=!0,z(),H.innerHTML="";var e=document.createElement("div"),o=(e.style.display="flex",e.style.flexDirection="column",e.style.alignItems="center",e.style.justifyContent="flex-start",e.style.width="100%",e.style.overflow="hidden",e.style.flex="1 1 0%",e.style.padding="16px",e.style.boxSizing="border-box",e.style.minHeight="0",document.createElement("div")),t=(o.style.width="100%",o.style.maxWidth="300px",o.style.display="flex",o.style.flexDirection="column",o.style.gap="16px",o.style.flexShrink="1",o.style.flexGrow="0",T.leadFormHelperText||{}),i=document.createElement("div"),t=(i.innerText=t.text||"To help us provide you with better service and personalized assistance, please share your details below.",i.style.fontSize=t.fontSize||"12px",i.style.lineHeight=t.lineHeight||"1.4",i.style.textAlign=t.textAlign||"center",i.style.padding=t.padding||"10px",i.style.marginBottom=t.marginBottom||"4px",i.style.border=t.border||"1px dashed #8348FF",i.style.background=t.background||"#f5f0ff",i.style.color=t.color||"#8348FF",i.style.fontStyle=t.fontStyle||"italic",i.style.borderRadius=t.borderRadius||"6px",i.style.flexShrink="0",document.createElement("div")),r=(t.style.display="flex",t.style.flexDirection="column",t.style.gap="4px",t.style.flexShrink="0",document.createElement("div")),d=(r.style.display="flex",r.style.alignItems="center",r.style.gap="24px",document.createElement("label")),c=(d.innerText="Full Name:*",d.style.width="27%",d.style.fontSize="14px",d.style.fontWeight="500",d.style.color="#374151",document.createElement("input")),p=(c.type="text",c.placeholder="Full name",c.style.width="60%",c.style.padding="12px 16px",c.style.border="1px solid #d1d5db",c.style.borderRadius="6px",c.style.fontSize="14px",c.style.outline="none",c.style.transition="border-color 0.2s ease-in-out",c.style.fontFamily="sans-serif",c.addEventListener("focus",function(){c.style.borderColor="#3b82f6",p.style.display="none",E()}),c.addEventListener("blur",function(){var e=V(c.value.trim());e.valid?(c.style.borderColor="#10b981",p.style.display="none"):(c.style.borderColor="#ef4444",p.innerText=e.message,p.style.display="block"),E()}),r.appendChild(d),r.appendChild(c),document.createElement("div")),n=(p.style.display="none",p.style.color="#ef4444",p.style.fontSize="11px",p.style.marginLeft="27%",p.style.paddingLeft="24px",p.style.paddingTop="2px",p.style.lineHeight="1.3",p.style.overflowWrap="break-word",p.style.flexShrink="0",p.innerText="Full name is required",t.appendChild(r),t.appendChild(p),document.createElement("div")),y=(n.style.display="flex",n.style.flexDirection="column",n.style.gap="4px",n.style.flexShrink="0",document.createElement("div")),m=(y.style.display="flex",y.style.alignItems="center",y.style.gap="24px",document.createElement("label")),u=(m.innerText="Email:*",m.style.width="27%",m.style.fontSize="14px",m.style.fontWeight="500",m.style.color="#374151",document.createElement("input")),g=(u.type="email",u.placeholder="Email",u.style.width="60%",u.style.padding="12px 16px",u.style.border="1px solid #d1d5db",u.style.borderRadius="6px",u.style.fontSize="14px",u.style.outline="none",u.style.transition="border-color 0.2s ease-in-out",u.style.fontFamily="sans-serif",u.addEventListener("focus",function(){u.style.borderColor="#3b82f6",g.style.display="none",E()}),u.addEventListener("blur",function(){var e=U(u.value.trim());e.valid?(u.style.borderColor="#10b981",g.style.display="none"):(u.style.borderColor="#ef4444",g.innerText=e.message,g.style.display="block"),E()}),y.appendChild(m),y.appendChild(u),document.createElement("div")),s=(g.style.display="none",g.style.color="#ef4444",g.style.fontSize="11px",g.style.marginLeft="27%",g.style.paddingLeft="24px",g.style.paddingTop="2px",g.style.lineHeight="1.3",g.style.overflowWrap="break-word",g.style.flexShrink="0",g.innerText="Please enter a valid email address",n.appendChild(y),n.appendChild(g),document.createElement("div")),f=(s.style.display="flex",s.style.flexDirection="column",s.style.gap="4px",s.style.flexShrink="0",document.createElement("div")),h=(f.style.display="flex",f.style.alignItems="center",f.style.gap="24px",document.createElement("label")),x=(h.innerText="Phone:*",h.style.width="27%",h.style.fontSize="14px",h.style.fontWeight="500",h.style.color="#374151",document.createElement("input")),b=(x.type="tel",x.placeholder="Phone number",x.maxLength=20,x.style.width="60%",x.style.padding="12px 16px",x.style.border="1px solid #d1d5db",x.style.borderRadius="6px",x.style.fontSize="14px",x.style.outline="none",x.style.transition="border-color 0.2s ease-in-out",x.style.fontFamily="sans-serif",x.addEventListener("focus",function(){x.style.borderColor="#3b82f6",b.style.display="none",E()}),x.addEventListener("blur",function(){var e=Q(x.value.trim());e.valid?(x.style.borderColor="#10b981",b.style.display="none"):(x.style.borderColor="#ef4444",b.innerText=e.message,b.style.display="block"),E()}),f.appendChild(h),f.appendChild(x),document.createElement("div")),l=(b.style.display="none",b.style.color="#ef4444",b.style.fontSize="11px",b.style.marginLeft="27%",b.style.paddingLeft="24px",b.style.paddingTop="2px",b.style.lineHeight="1.3",b.style.overflowWrap="break-word",b.style.flexShrink="0",b.innerText="Please enter a valid phone number",s.appendChild(f),s.appendChild(b),document.createElement("div")),v=(l.style.display="flex",l.style.flexDirection="column",l.style.gap="4px",l.style.flexShrink="0",document.createElement("div")),w=(v.style.display="flex",v.style.alignItems="center",v.style.gap="24px",document.createElement("label")),k=(w.innerText="Zip Code:*",w.style.width="27%",w.style.fontSize="14px",w.style.fontWeight="500",w.style.color="#374151",document.createElement("input")),C=(k.type="text",k.placeholder="Zip code",k.style.width="60%",k.style.padding="12px 16px",k.style.border="1px solid #d1d5db",k.style.borderRadius="6px",k.style.fontSize="14px",k.style.outline="none",k.style.transition="border-color 0.2s ease-in-out",k.style.fontFamily="sans-serif",k.addEventListener("focus",function(){k.style.borderColor="#3b82f6",C.style.display="none",E()}),k.addEventListener("blur",function(){var e=Y(k.value.trim());e.valid?(k.style.borderColor="#10b981",C.style.display="none"):(k.style.borderColor="#ef4444",C.innerText=e.message,C.style.display="block"),E()}),v.appendChild(w),v.appendChild(k),document.createElement("div")),S=(C.style.display="none",C.style.color="#ef4444",C.style.fontSize="11px",C.style.marginLeft="27%",C.style.paddingLeft="24px",C.style.paddingTop="2px",C.style.lineHeight="1.3",C.style.overflowWrap="break-word",C.style.flexShrink="0",C.innerText="Please enter a valid zip/postal code",l.appendChild(v),l.appendChild(C),o.appendChild(i),o.appendChild(t),o.appendChild(n),o.appendChild(s),o.appendChild(l),document.createElement("button"));function E(){var t,n,s,l=0;"block"===p.style.display&&l++,"block"===g.style.display&&l++,"block"===b.style.display&&l++,"block"===C.style.display&&l++,0<l?(o.style.gap=Math.max(8,16-2*l)+"px",e.style.padding=Math.max(8,16-l)+"px",t=Math.max(25,27-.5*l)+"%",n=Math.max(55,60-.5*l)+"%",s=Math.max(12,24-2*l)+"px",[d,m,h,w].forEach(function(e){e.style.width=t,e.style.fontSize=Math.max(12,14-.3*l)+"px"}),[c,u,x,k].forEach(function(e){e.style.width=n,e.style.padding=Math.max(8,12-.5*l)+"px "+Math.max(12,16-l)+"px",e.style.fontSize=Math.max(13,14-.2*l)+"px"}),[r,y,f,v].forEach(function(e){e.style.gap=s}),[p,g,b,C].forEach(function(e){e.style.marginLeft=t,e.style.paddingLeft=s,e.style.fontSize=Math.max(10,11-.2*l)+"px"}),i.style.padding=Math.max(6,10-l)+"px",i.style.fontSize=Math.max(11,12-.2*l)+"px",i.style.marginBottom=Math.max(2,4-.5*l)+"px"):(o.style.gap="16px",e.style.padding="16px",[d,m,h,w].forEach(function(e){e.style.width="27%",e.style.fontSize="14px"}),[c,u,x,k].forEach(function(e){e.style.width="60%",e.style.padding="12px 16px",e.style.fontSize="14px"}),[r,y,f,v].forEach(function(e){e.style.gap="24px"}),[p,g,b,C].forEach(function(e){e.style.marginLeft="27%",e.style.paddingLeft="24px",e.style.fontSize="11px"}),i.style.padding="10px",i.style.fontSize="12px",i.style.marginBottom="4px")}S.innerText="Start Chat",S.style.width="100%",S.style.maxWidth="300px",S.style.padding="12px 24px",S.style.background=I.sendBtnBg||"#16a34a",S.style.color="#ffffff",S.style.border="none",S.style.borderRadius="6px",S.style.cursor="pointer",S.style.fontWeight="600",S.style.fontSize="14px",S.style.transition="background-color 0.2s ease-in-out",S.style.flexShrink="0",S.style.marginTop="8px",S.addEventListener("mouseover",function(){S.style.backgroundColor=I.sendBtnHover||"#15803d"}),S.addEventListener("mouseout",function(){S.style.backgroundColor=I.sendBtnBg||"#16a34a"}),S.onclick=async function(){var e,t=c.value.trim(),n=u.value.trim(),s=x.value.trim(),l=k.value.trim(),o=!1,t=V(t),n=(t.valid?(c.style.borderColor="#10b981",p.style.display="none"):(c.style.borderColor="#ef4444",p.innerText=t.message,p.style.display="block",o=!0),U(n)),s=(n.valid?(u.style.borderColor="#10b981",g.style.display="none"):(u.style.borderColor="#ef4444",g.innerText=n.message,g.style.display="block",o=!0),Q(s)),l=(s.valid?(x.style.borderColor="#10b981",b.style.display="none"):(x.style.borderColor="#ef4444",b.innerText=s.message,b.style.display="block",o=!0),Y(l));l.valid?(k.style.borderColor="#10b981",C.style.display="none"):(k.style.borderColor="#ef4444",C.innerText=l.message,C.style.display="block",o=!0),E(),o?t.valid?n.valid?s.valid?l.valid||k.focus():x.focus():u.focus():c.focus():(H.innerHTML="",M?await A(B(c.value),B(u.value),B(x.value),B(k.value)):await A(null,null,null,null),o=navigator.userAgent,t=navigator.platform,n=window.location.href,s=(new Date).toISOString(),l=navigator.language,e=document.referrer,s={name:B(c.value),email:B(u.value),phone:B(x.value),zip:B(k.value),timestamp:s,userAgent:o,platform:t,url:n,language:l,referrer:e,ip:""},(o=JSON.parse(localStorage.getItem("simple-chat-leads")||"[]")).push(s),localStorage.setItem("simple-chat-leads",JSON.stringify(o)),a(s),_(`${c.value} ${u.value} ${x.value} `+k.value))},c.addEventListener("keydown",function(e){"Enter"===e.key&&S.click()}),u.addEventListener("keydown",function(e){"Enter"===e.key&&S.click()}),x.addEventListener("keydown",function(e){"Enter"===e.key&&S.click()}),k.addEventListener("keydown",function(e){"Enter"===e.key&&S.click()}),o.appendChild(S),e.appendChild(o),H.appendChild(e),c.focus()}function E(){var e;y.style.display="flex",y.style.flexDirection="column",y.style.width="100%",y.style.boxSizing="border-box",y.style.padding="16px",y.style.gap="0",y.style.flex="0 0 auto",y.style.borderTop="1px solid #ececec",y.style.background="#ffffff",T.quickQuestions&&0<T.quickQuestions.length&&(e=0===(e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).length||1===e.length&&e[0].isWelcomeMessage,T.quickQuestionsPermanent||e?u.style.display="flex":u.style.display="none"),f.style.display="grid",f.style.gridTemplateColumns="1fr auto",f.style.gap="16px",f.style.alignItems="center",f.style.width="100%",h.style.padding="12px 16px",h.style.border="1px solid #d1d5db",h.style.borderRadius="6px",h.style.background=I.inputBg,h.style.color=I.inputText,h.style.fontSize="14px",h.style.lineHeight="20px",h.style.outline="none",h.style.transition="border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out",x.style.padding="12px",x.style.background=I.sendBtnBg||"#3b82f6",x.style.color="#ffffff",x.style.border="none",x.style.borderRadius="6px",x.style.cursor="pointer",x.style.display="flex",x.style.alignItems="center",x.style.justifyContent="center",x.style.transition="background-color 0.2s ease-in-out"}function B(e){return String(e).replace(/[&<>"']/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]})}function V(e){return!e||"string"!=typeof e||0===(e=e.trim()).length?{valid:!1,message:"Full name is required"}:e.length<2?{valid:!1,message:"Full name must be at least 2 characters"}:100<e.length?{valid:!1,message:"Full name is too long (maximum 100 characters)"}:/[a-zA-Z]/.test(e)?/^[a-zA-Z\s\-'\.]{2,100}$/.test(e)?e.includes("  ")?{valid:!1,message:"Full name cannot contain consecutive spaces"}:{valid:!0,message:""}:{valid:!1,message:"Full name contains invalid characters"}:{valid:!1,message:"Full name must contain at least one letter"}}function U(e){var t,n;return!e||"string"!=typeof e||0===(e=e.trim()).length?{valid:!1,message:"Email is required"}:254<e.length?{valid:!1,message:"Email address is too long (maximum 254 characters)"}:!/^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/.test(e)||2!==(t=e.split("@")).length?{valid:!1,message:"Please enter a valid email address"}:(n=t[1],0===(t=t[0]).length||64<t.length||0===n.length||255<n.length?{valid:!1,message:"Email address format is invalid"}:(n=n.split(".")).length<2?{valid:!1,message:"Email address must include a valid domain"}:/^[a-zA-Z]{2,}$/.test(n[n.length-1])?e.includes("..")?{valid:!1,message:"Email address cannot contain consecutive dots"}:t.startsWith(".")||t.endsWith(".")?{valid:!1,message:"Email address format is invalid"}:{valid:!0,message:""}:{valid:!1,message:"Email address must include a valid domain extension"})}function Q(e){var t;return!e||"string"!=typeof e||0===(e=e.trim()).length?{valid:!1,message:"Phone number is required"}:(t=e.replace(/[\s\-\(\)\.\+]/g,""),/^\d+$/.test(t)?t.length<7?{valid:!1,message:"Phone number must contain at least 7 digits"}:15<t.length?{valid:!1,message:"Phone number cannot exceed 15 digits"}:(e.match(/[\s\-\(\)\.\+]/g)||[]).length>t.length?{valid:!1,message:"Phone number has too many formatting characters"}:20<e.length?{valid:!1,message:"Phone number is too long (maximum 20 characters including formatting)"}:{valid:!0,message:""}:{valid:!1,message:"Phone number can only contain digits and formatting characters (spaces, dashes, parentheses, dots, plus)"})}function Y(e){return!e||"string"!=typeof e||0===(e=e.trim()).length?{valid:!1,message:"Zip code is required"}:/^\d{5}(-\d{4})?$/.test(e)||/^[A-Za-z]\d[A-Za-z][\s-]?\d[A-Za-z]\d$/.test(e)||/^[A-Z]{1,2}\d{1,2}[A-Z]?\s?\d[A-Z]{2}$/i.test(e)?{valid:!0,message:""}:/^[A-Za-z0-9\s\-]{5,15}$/.test(e)?/[A-Za-z0-9]/.test(e)?{valid:!0,message:""}:{valid:!1,message:"Zip code must contain letters or numbers"}:{valid:!1,message:"Please enter a valid zip/postal code (e.g., 12345, 12345-6789, A1A 1A1)"}}x.title="Send",x.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>',x.style.padding="12px",x.style.background=I.sendBtnBg||"#3b82f6",x.style.color="#ffffff",x.style.border="none",x.style.borderRadius="6px",x.style.cursor="pointer",x.style.display="flex",x.style.alignItems="center",x.style.justifyContent="center",x.style.transition="background-color 0.2s ease-in-out",x.addEventListener("mouseover",function(){x.style.backgroundColor=I.sendBtnHover||"#2563eb"}),x.addEventListener("mouseout",function(){x.style.backgroundColor=I.sendBtnBg||"#3b82f6"}),f.appendChild(h),f.appendChild(x),y.appendChild(f),t.appendChild(y),document.body.appendChild(t),H.addEventListener("scroll",function(){w()}),x.onclick=_,h.addEventListener("keydown",function(e){"Enter"===e.key&&(e.preventDefault(),_())});var N=document.createElement("button");function G(){window.innerWidth,N.style.bottom="20px","left"===T.position?(N.style.left="20px",N.style.right="auto"):(N.style.right="20px",N.style.left="auto")}N.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle-icon lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>',N.style.position="fixed",N.style.bottom="20px","left"===T.position?(N.style.left="20px",N.style.right="auto"):(N.style.right="20px",N.style.left="auto"),N.style.width="80px",N.style.height="80px",N.style.borderRadius="50%",N.style.backgroundColor=I.sendBtnBg||"#16a34a",N.style.color="#ffffff",N.style.border="none",N.style.cursor="pointer",N.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",N.style.display="flex",N.style.alignItems="center",N.style.justifyContent="center",N.style.transition="all 0.3s ease",N.style.zIndex=I.zIndex-1,G(),window.addEventListener("resize",G);var K=!(t.style.display="none");N.addEventListener("click",function(){(K=!K)?(t.style.display="flex",N.style.display="none",setTimeout(function(){$()},150)):(t.style.display="none",N.style.display="flex")}),P.onclick=function(){K=!1,t.style.display="none",N.style.display="flex"},document.body.appendChild(N),window.saveMessage=k,window.loadMessages=v,window.generateChatId=j,window.generateSecureWsParams=F,window.connectWebSocket=C;let A=async(t,e,n,s)=>{try{var l=T.baseUrl,o=T.token;if(!l||!o)throw console.error("baseUrl and token must be provided in SimpleChatEmbedConfig"),new Error("Missing required configuration: baseUrl and token");var a,i=!e,r={userAgent:navigator.userAgent,platform:navigator.platform,language:navigator.language,referrer:document.referrer||"direct",url:window.location.href,timestamp:(new Date).toISOString(),screenResolution:window.screen.width+"x"+window.screen.height,timezone:Intl.DateTimeFormat().resolvedOptions().timeZone,cookiesEnabled:navigator.cookieEnabled};i&&(a=[r.userAgent,r.platform,r.language,r.screenResolution,r.timezone,r.cookiesEnabled,navigator.hardwareConcurrency||"unknown",navigator.maxTouchPoints||0,screen.colorDepth||"unknown",(new Date).getTimezoneOffset()].join("|"),e=`anonymous_${btoa(a).replace(/[^a-zA-Z0-9]/g,"").substring(0,40)}@memox.local`,t="Anonymous Visitor");var d=await(await fetch(l+"visitors/?email="+e,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Token ${o} `}})).json();if("Not found."!==d.detail&&d.results?.length)m={id:d?.results[0].id,name:d?.results[0].name};else{var c={name:t,email:e,phone_number:n||"",zip_code:s||"",organization:T.org_id,metadata:{browser_metadata:r,anonymous:i}},p=await fetch(l+"visitors/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Token ${o} `},body:JSON.stringify(c)});if(!p.ok)throw new Error("Failed to create visitor: "+p.status);var y=await p.json();m={id:y.id,name:y.name}}}catch(e){console.error("Error creating/fetching visitor:",e),m={id:"offline_"+Date.now(),name:t}}};if(M){e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"),n=localStorage.getItem("simple-chat-session");if(0<e.length&&n){window.__simpleChatEmbedLeadCaptured=!0;try{var X=JSON.parse(n);m=X.visitorInfo,!0===X.handoverOccurred&&(g=!0)}catch(e){console.log("Error parsing session data:",e)}E(),v(),setTimeout(function(){$()},200),C()}else window.__simpleChatEmbedLeadCaptured?(E(),v()):(y.style.display="none",q(function(e){L=!1,z(),window.__simpleChatEmbedLeadCaptured=!0,e&&(window.SimpleChatEmbedLead=e),E();JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");s&&k(s,"bot","welcomeMessage"),v()}))}else window.__simpleChatEmbedLeadCaptured=!0,E(),A(null,null,null,null).then(()=>{s&&k(s,"bot","welcomeMessage"),v(),C()}).catch(e=>{console.error("Failed to create anonymous visitor:",e),s&&k(s,"bot","welcomeMessage"),v(),C()});setTimeout(function(){var e=localStorage.getItem("simple-chat-session");if(e)try{var t=JSON.parse(e),n=new Date-new Date(t.timestamp);t.chatID&&t.workflowId&&t.hashedWorkflowId&&t.hash&&t.visitorInfo&&n<864e5&&(m=t.visitorInfo,r||a||C())}catch(e){console.log("Error checking stored session for auto-connect:",e)}},100)}"undefined"==typeof marked?((e=document.createElement("script")).src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js",e.onload=function(){console.log("Marked.js library loaded"),t()},e.onerror=function(){console.warn("Failed to load marked.js from CDN, initializing without it"),t()},document.head.appendChild(e)):t()})();