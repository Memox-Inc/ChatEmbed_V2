!function(){var e={title:"Chat",theme:{primary:"#0078d4",userBubble:"#e6f0fa",botBubble:"#f1f1f1",userText:"#22223b",botText:"#4a4e69",background:"#fff",border:"#ccc",text:"#222",width:"100%",maxWidth:"350px",minWidth:"220px",borderRadius:"8px",fontFamily:"sans-serif",zIndex:9999,headerText:"#fff",headerBg:"rgba(34, 34, 59, 0.95)",inputBg:"#fff",inputText:"#222",sendBtnBg:"#0078d4",sendBtnText:"#fff",sendBtnHover:"#005fa3",shadow:"0 2px 8px rgba(0,0,0,0.15)",salesRepBubble:"#f1f5f9",salesRepText:"#475569",salesRepAvatar:"#E4E7FC",userAvatar:"#8349ff",botAvatar:"#E4E7FC",handoverNotificationBg:"#E4E7FC",handoverNotificationText:"#334155",handoverNotificationBorder:"#8349FF"}},t=window.SimpleChatEmbedConfig?{...e,...window.SimpleChatEmbedConfig,theme:{...e.theme,...window.SimpleChatEmbedConfig.theme||{}}}:e,n=t.theme,s=(t.apiUrl,t.welcomeMessage||null),o=t.workflowId,r=t.socketUrl+"/ws/chat/",l=null,a=!1,i=null,d=!1;function c(e){const t=btoa(String(e)),n=new TextEncoder,s=n.encode("4f3c9a1d8e5b6c2f719a0e3d5a8b7c4d9e6f1a0b3d7c8e2f6a9d0e1b4c5f7a6d"),o=n.encode(t);return window.crypto.subtle.importKey("raw",s,{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then((e=>window.crypto.subtle.sign("HMAC",e,o))).then((e=>{const n=Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("");return{hashed_workflow_id:t,hash:n}}))}function m(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}var y=document.createElement("div");function p(){window.innerWidth<768?(y.style.position="fixed",y.style.top="0",y.style.left="0",y.style.right="0",y.style.bottom="0",y.style.width="100%",y.style.height="100vh",y.style.borderRadius="0",y.style.maxHeight="100vh"):(y.style.position="fixed",y.style.top="auto",y.style.left="auto",y.style.right="20px",y.style.bottom="20px",y.style.width="384px",y.style.height="80vh",y.style.borderRadius="0.75rem",y.style.maxHeight="600px")}y.id="simple-chat-embed",y.style.position="fixed",y.style.bottom="20px",y.style.right="20px",y.style.width="384px",y.style.height="80vh",y.style.maxHeight="600px",y.style.background="#ffffff",y.style.border="1px solid #e2e8f0",y.style.borderRadius="0.75rem",y.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",y.style.fontFamily=n.fontFamily+", Inter, system-ui, sans-serif",y.style.zIndex=n.zIndex,y.style.color=n.text,y.style.transition="transform 0.3s ease-in-out",y.style.display="flex",y.style.flexDirection="column",y.style.overflow="hidden",p(),window.addEventListener("resize",p);var u=document.createElement("div");u.style.display="flex",u.style.justifyContent="space-between",u.style.alignItems="center",u.style.background=n.headerBg||"#16a34a",u.style.color=n.headerText,u.style.padding="2rem",u.style.borderTopLeftRadius="0.75rem",u.style.borderTopRightRadius="0.75rem",u.style.fontWeight="600",u.style.fontSize="1.125rem",u.style.lineHeight="1.75rem";var f=document.createElement("div");f.innerText=t.title,u.appendChild(f);var g=document.createElement("div");g.style.display="flex";var h=document.createElement("button");h.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="m21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>',h.title="Reset chat",h.style.background="transparent",h.style.color=n.headerText,h.style.border="none",h.style.padding="0.5rem",h.style.cursor="pointer",h.style.borderRadius="0.375rem",h.style.display="flex",h.style.alignItems="center",h.style.justifyContent="center",h.style.transition="background-color 0.2s ease-in-out",h.onmouseover=function(){h.style.backgroundColor="rgba(255,255,255,0.1)"},h.onmouseout=function(){h.style.backgroundColor="transparent"},h.onclick=function(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]").some((function(e){return e.isSystemNotification&&"joined"===e.notificationType})),t=localStorage.getItem("simple-chat-session"),n=!1;if(t)try{n=!0===JSON.parse(t).handoverOccurred}catch(e){console.log("Error reading session handover flag:",e)}localStorage.removeItem("simple-chat-messages"),d=!(!e&&!n),console.log("Reset chat: handover status preserved =",d),J(),s&&R(s,"bot","welcomeMessage"),B()};var b=document.createElement("button");b.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',b.title="Close chat",b.style.background="transparent",b.style.color=n.headerText,b.style.border="none",b.style.padding="0.5rem",b.style.cursor="pointer",b.style.borderRadius="0.375rem",b.style.display="flex",b.style.alignItems="center",b.style.justifyContent="center",b.style.transition="background-color 0.2s ease-in-out",b.onmouseover=function(){b.style.backgroundColor="rgba(255,255,255,0.1)"},b.onmouseout=function(){b.style.backgroundColor="transparent"};var x=b;g.appendChild(h),g.appendChild(b),u.appendChild(g);var v=document.createElement("div");v.style.height="1px",v.style.background="#e2e8f0",v.style.marginBottom="1rem",y.appendChild(u),y.appendChild(v);var w=document.createElement("div");w.style.flex="1 1 0%",w.style.overflowY="auto",w.style.overflowX="hidden",w.style.padding="1rem",w.style.background="#ffffff",w.id="chat-messages",w.style.display="flex",w.style.flexDirection="column",w.style.gap="1rem",w.style.scrollBehavior="smooth",w.style.scrollbarWidth="none",w.style.msOverflowStyle="none";var S=document.createElement("style");S.textContent="\n        #chat-messages::-webkit-scrollbar { display: none; }\n        #simple-chat-embed ul { list-style-type: disc !important; }\n        #simple-chat-embed ol { list-style-type: decimal !important; }\n        #simple-chat-embed ul li::marker { color: #6b7280; }\n        #simple-chat-embed ol li::marker { color: #6b7280; font-weight: 600; }\n        #simple-chat-embed pre { white-space: pre-wrap; word-wrap: break-word; }\n        #simple-chat-embed code { word-wrap: break-word; }\n        #simple-chat-embed blockquote { \n            border-left: 4px solid #e5e7eb; \n            padding-left: 1rem; \n            margin: 1rem 0; \n            color: #6b7280; \n            font-style: italic; \n        }\n    ",document.head.appendChild(S),y.appendChild(w);var k=document.createElement("button");k.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 13 5 5 5-5"/><path d="M12 18V6"/></svg>',k.title="Scroll to bottom",k.style.position="absolute",k.style.right="1rem",k.style.bottom="5rem",k.style.width="40px",k.style.height="40px",k.style.borderRadius="50%",k.style.background=n.sendBtnBg||"#3b82f6",k.style.color="#ffffff",k.style.border="none",k.style.cursor="pointer",k.style.display="none",k.style.alignItems="center",k.style.justifyContent="center",k.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",k.style.transition="all 0.3s ease",k.style.zIndex="10",k.addEventListener("mouseover",(function(){k.style.backgroundColor=n.sendBtnHover||"#2563eb",k.style.transform="scale(1.1)"})),k.addEventListener("mouseout",(function(){k.style.backgroundColor=n.sendBtnBg||"#3b82f6",k.style.transform="scale(1)"})),k.onclick=function(){w.scrollTop=w.scrollHeight,k.style.display="none"},y.appendChild(k);var C=document.createElement("div");C.style.height="1px",C.style.background="#e2e8f0",C.style.marginTop="1rem";var E=document.createElement("div");E.style.padding="1rem",E.style.background="#ffffff",E.style.display="flex",E.style.flexDirection="column",E.style.borderBottomLeftRadius="0.75rem",E.style.borderBottomRightRadius="0.75rem",y.appendChild(C),y.appendChild(E);var I=document.createElement("div");I.style.display="grid",I.style.gridTemplateColumns="1fr auto",I.style.gap="1rem",I.style.alignItems="center",I.style.width="100%";var T=document.createElement("input");T.type="text",T.placeholder="Type your message...",T.style.padding="0.75rem 1rem",T.style.border="1px solid #d1d5db",T.style.borderRadius="0.375rem",T.style.background="#ffffff",T.style.color="#374151",T.style.fontSize="0.875rem",T.style.lineHeight="1.25rem",T.style.outline="none",T.style.transition="border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out",T.addEventListener("focus",(function(){T.style.borderColor="#3b82f6",T.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.1)"})),T.addEventListener("blur",(function(){T.style.borderColor="#d1d5db",T.style.boxShadow="none"}));var M=document.createElement("button");function L(){var e=document.createElement("span");e.style.display="inline-flex",e.style.alignItems="center",e.style.height="1.5em";var t=n.botText||"#4a4e69";if(e.innerHTML=`\n      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s infinite alternate;"></span>\n      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.2s infinite alternate;"></span>\n      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.4s infinite alternate;"></span>\n    `,!document.getElementById("simple-chat-bounce-style")){var s=document.createElement("style");s.id="simple-chat-bounce-style",s.innerHTML="@keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-7px); } }",document.head.appendChild(s)}return e}function _(e,t=!1){if(!e)return"";var s=e;if(t)return s=(s=(s=(s=s.replace(/\*\*([^*]+)\*\*/g,'<strong style="font-weight:600;">$1</strong>')).replace(/\*([^*]+)\*/g,'<em style="font-style:italic;">$1</em>')).replace(/`([^`]+)`/g,"<code style=\"background:#f6f8fa;border-radius:3px;padding:2px 4px;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:85%;\">$1</code>")).replace(/\n/g,"<br>");if((s=(s=(s=(s=(s=(s=(s=s.replace(/```([^`]+)```/g,(function(e,t){return"<pre style=\"background:#f6f8fa;border:1px solid #e1e4e8;border-radius:6px;padding:16px;margin:8px 0;overflow-x:auto;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:13px;line-height:1.45;\"><code>"+N(t.trim())+"</code></pre>"}))).replace(/`([^`]+)`/g,(function(e,t){return"<code style=\"background:#f6f8fa;border-radius:3px;padding:2px 4px;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:85%;\">"+N(t)+"</code>"}))).replace(/\*\*([^*]+)\*\*/g,'<strong style="font-weight:600;">$1</strong>')).replace(/__([^_]+)__/g,'<strong style="font-weight:600;">$1</strong>')).replace(/\*([^*]+)\*/g,'<em style="font-style:italic;">$1</em>')).replace(/_([^_]+)_/g,'<em style="font-style:italic;">$1</em>')).replace(/\[([^\]]+)\]\(([^)]+)\)/g,(function(e,t,s){return'<a href="'+s+'" target="_blank" style="font-weight:bold;color:'+(n.botText||"#4a4e69")+';text-decoration:underline;cursor:pointer;">'+t+"</a>"}))).includes("\n")){for(var o=s.split("\n"),r=!1,l=!1,a=[],i=0;i<o.length;i++){var d=o[i],c=d.trim(),m=c.match(/^>\s+(.+)$/);if(m)r&&(a.push("</ul>"),r=!1),l&&(a.push("</ol>"),l=!1),a.push('<blockquote style="border-left:4px solid #e5e7eb;padding-left:1rem;margin:1rem 0;color:#6b7280;font-style:italic;">'+m[1]+"</blockquote>");else{var y=c.match(/^[-*+]\s+(.+)$/);if(y)r||(l&&(a.push("</ol>"),l=!1),a.push('<ul style="margin:8px 0;padding-left:24px;list-style-type:disc;">'),r=!0),a.push('<li style="margin:4px 0;">'+y[1]+"</li>");else{var p=c.match(/^(\d+)\.\s+(.+)$/);if(p)l||(r&&(a.push("</ul>"),r=!1),a.push('<ol style="margin:8px 0;padding-left:24px;">'),l=!0),a.push('<li style="margin:4px 0;">'+p[2]+"</li>");else{if(r&&(a.push("</ul>"),r=!1),l&&(a.push("</ol>"),l=!1),c.match(/^#{1,6}\s+/)){var u=c.match(/^(#{1,6})\s+(.+)$/);if(u){var f=u[1].length,g=u[2],h=["1.5em","1.3em","1.1em","1em","0.9em","0.8em"][f-1];a.push("<h"+f+' style="font-size:'+h+";font-weight:600;margin:12px 0 8px 0;color:"+(n.botText||"#4a4e69")+';">'+g+"</h"+f+">");continue}}c?a.push(d):a.push("<br>")}}}}r&&a.push("</ul>"),l&&a.push("</ol>"),s=a.join("\n")}return s=s.replace(/\n/g,"<br>")}function N(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function B(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");w.innerHTML="";var t,s=e.some((function(e){return e.isSystemNotification&&"joined"===e.notificationType}));s&&(d=!0);for(var o=0;o<e.length;o++){var r=e[o];if(r.isSystemNotification){var l=document.createElement("div");l.style.display="flex",l.style.justifyContent="center",l.style.margin="1rem 0",l.style.animation="fadeInUp 0.5s ease-out";var a=document.createElement("div");a.style.background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",a.style.color="#ffffff",a.style.padding="0.75rem 1.5rem",a.style.borderRadius="20px",a.style.fontSize="0.875rem",a.style.fontWeight="500",a.style.display="flex",a.style.alignItems="center",a.style.gap="0.5rem",a.style.maxWidth="80%",a.style.textAlign="center";var i=document.createElement("span");if("joined"===r.notificationType?(i.innerHTML="👋",a.style.background=n.handoverNotificationBg||"#E4E7FC",a.style.color=n.handoverNotificationText||"#334155",a.style.border="1px solid "+(n.handoverNotificationBorder||"#8349FF")):i.innerHTML="💬",i.style.fontSize="1rem",a.appendChild(i),a.appendChild(document.createTextNode(r.text)),l.appendChild(a),!document.getElementById("system-notification-style")){var c=document.createElement("style");c.id="system-notification-style",c.innerHTML="\n                        @keyframes fadeInUp {\n                            0% { opacity: 0; transform: translateY(20px); }\n                            100% { opacity: 1; transform: translateY(0); }\n                        }\n                    ",document.head.appendChild(c)}w.appendChild(l)}else{var m=document.createElement("div");m.style.display="flex",m.style.flexDirection="column",m.style.marginBottom="1rem";var y=document.createElement("div");y.style.display="flex",y.style.gap="0.5rem","user"===r.sender&&(y.style.flexDirection="row-reverse",y.style.justifyContent="flex-start");var p=null;if("user"===r.sender){(p=document.createElement("div")).style.width="40px",p.style.height="40px",p.style.borderRadius="50%",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.style.background=n.userAvatar||"#8349ff";var u=document.createElement("div");u.innerHTML='\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M19 21V19C19 17.9391 18.5786 16.9217 17.8284 16.1716C17.0783 15.4214 16.0609 15 15 15H9C7.93913 15 6.92172 15.4214 6.17157 16.1716C5.42143 16.9217 5 17.9391 5 19V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                ',p.appendChild(u)}else if("sales_rep"===r.sender){(p=document.createElement("div")).style.width="40px",p.style.height="40px",p.style.borderRadius="50%",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.style.background=n.salesRepAvatar||"#E4E7FC";var f=n.primary||"#8349FF";p.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" style="width:26px;height:26px;color:'+f+';" width="200" height="200" viewBox="0 0 24 24"><path fill="currentColor" d="M19.938 8H21a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1.062A8.001 8.001 0 0 1 12 23v-2a6 6 0 0 0 6-6V9A6 6 0 0 0 6 9v7H3a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1.062a8.001 8.001 0 0 1 15.876 0ZM3 10v4h1v-4H3Zm17 0v4h1v-4h-1ZM7.76 15.785l1.06-1.696A5.972 5.972 0 0 0 12 15a5.972 5.972 0 0 0 3.18-.911l1.06 1.696A7.963 7.963 0 0 1 12 17a7.962 7.962 0 0 1-4.24-1.215Z"/></svg>'}else if("bot"===r.sender||"ai"===r.sender){(p=document.createElement("div")).style.width="40px",p.style.height="40px",p.style.borderRadius="50%",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.style.background=n.botAvatar||"#E4E7FC";var g=document.createElement("div");f=n.primary||"#8349ff";g.innerHTML=`\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <g clip-path="url(#clip0_4_4929)">\n                            <path d="M19 11H5C3.89543 11 3 11.8954 3 13V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V13C21 11.8954 20.1046 11 19 11Z" stroke="${f}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            <path d="M12 7C13.1046 7 14 6.10457 14 5C14 3.89543 13.1046 3 12 3C10.8954 3 10 3.89543 10 5C10 6.10457 10.8954 7 12 7Z" stroke="${f}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            <path d="M12 7V11" stroke="${f}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                        </g>\n                        <defs>\n                            <clipPath id="clip0_4_4929">\n                                <rect width="24" height="24" fill="white"/>\n                            </clipPath>\n                        </defs>\n                    </svg>\n                `,p.appendChild(g)}var h=document.createElement("div");h.style.display="flex",h.style.flexDirection="column",h.style.gap="0.5rem",h.style.maxWidth=(r.sender,"70%");var b=document.createElement("div");if(b.style.padding="0.75rem 1rem",b.style.wordBreak="break-word",b.style.fontSize="0.875rem",b.style.lineHeight="1.25rem",b.style.position="relative","user"===r.sender?(b.style.backgroundColor=n.userBubble||"#dbeafe",b.style.color=n.userText||"#1e40af",b.style.alignSelf="flex-end",b.style.borderRadius="1rem 1rem 0.25rem 1rem",b.style.boxShadow="0 2px 8px rgba(59, 130, 246, 0.15)"):"sales_rep"===r.sender?(b.style.background=n.salesRepBubble||"#f1f5f9",b.style.color=n.salesRepText||"#475569",b.style.alignSelf="flex-start",b.style.borderRadius="1rem 1rem 1rem 0.25rem"):(b.style.backgroundColor=n.botBubble||"#f1f5f9",b.style.color=n.botText||"#475569",b.style.alignSelf="flex-start",b.style.borderRadius="1rem 1rem 1rem 0.25rem",b.style.boxShadow="0 2px 8px rgba(71, 85, 105, 0.1)"),""===r.text&&o===e.length-1)b.appendChild(L());else if("[Image]"===r.text&&o>0&&("string"==typeof(t=e[o-1].text)&&t.startsWith("data:image/"))){var x=document.createElement("img");x.src=e[o-1].text,x.style.maxWidth="200px",x.style.maxHeight="150px",x.style.borderRadius="0.5rem",x.style.display="block",b.appendChild(x)}else{var v=document.createElement("div"),S=!0===r.isStreaming;if("bot"===r.sender||"ai"===r.sender)v.innerHTML=_(r.text,S);else if("sales_rep"===r.sender){var k=N(r.text).replace(/\n/g,"<br>"),C="Sales Representative";r.senderName&&("string"==typeof r.senderName?C=r.senderName:r.senderName.name&&(C=r.senderName.name)),v.innerHTML='<div style=" padding-bottom: 6px; font-size: 0.75rem; color: #6b7280; font-weight: 500;">~ '+C+"</div>"+k,v.style.fontWeight="500",v.style.lineHeight="1.4",v.style.display="block",v.style.width="100%"}else v.innerHTML=N(r.text).replace(/\n/g,"<br>");b.appendChild(v)}if(h.appendChild(b),!r.isWelcomeMessage){var E=document.createElement("div");E.style.fontSize="0.75rem",E.style.color="#9ca3af",E.style.alignSelf="user"===r.sender?"flex-end":"flex-start",E.innerText=r.created_at,h.appendChild(E)}p&&y.appendChild(p),y.appendChild(h),m.appendChild(y),w.appendChild(m)}}w.scrollTop=w.scrollHeight,setTimeout((function(){w.scrollTop=w.scrollHeight,H()}),100)}function H(){var e=w.scrollHeight-w.scrollTop<=w.clientHeight+100;k.style.display=e?"none":"flex"}function O(){var e=0;!function t(){w.scrollTop=w.scrollHeight,++e<5&&w.scrollTop<w.scrollHeight-w.clientHeight-10?setTimeout(t,50):H()}()}function R(e,t,n=""){var s=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");if("welcomeMessage"===n){const n=s.findIndex((e=>e.isWelcomeMessage));-1!==n?s[n].text=e:s.push({text:e,isWelcomeMessage:!0,sender:t})}else s.push({text:e,isWelcomeMessage:!1,sender:t,created_at:z((new Date).toISOString())});localStorage.setItem("simple-chat-messages",JSON.stringify(s))}async function W(){if(!a&&!l){var e,t,n,s=localStorage.getItem("simple-chat-session");if(s)try{var y=JSON.parse(s),p=new Date-new Date(y.timestamp);if(!(y.chatID&&y.workflowId&&y.hashedWorkflowId&&y.hash&&y.visitorInfo&&p<864e5))throw new Error("Invalid or expired session");e=y.chatID,t=y.workflowId,n={hashed_workflow_id:y.hashedWorkflowId,hash:y.hash},i=y.visitorInfo,console.log("Using stored session data for WebSocket connection")}catch(e){console.log("Invalid session data, generating new session"),localStorage.removeItem("simple-chat-session"),s=null}if(!s&&(e=m(),t=o,n=await c(t),console.log("Generated new session data for WebSocket connection"),i)){var u={chatID:e,workflowId:t,hashedWorkflowId:n.hashed_workflow_id,hash:n.hash,visitorInfo:i,timestamp:(new Date).toISOString()};localStorage.setItem("simple-chat-session",JSON.stringify(u))}var f=`${r}${e}/?workflow_id=${n.hashed_workflow_id}&hash=${n.hash}&visitorInfo=${JSON.stringify(i)}`;try{(l=new WebSocket(f)).onopen=function(){a=!0},l.onmessage=function(e){var t=JSON.parse(e.data);if("unread_message"!==t?.message_type){if("handover_message"===t?.message_type){console.log("Handover message received:",t),d=!0;var n=localStorage.getItem("simple-chat-session");if(n)try{var s=JSON.parse(n);s.handoverOccurred=!0,localStorage.setItem("simple-chat-session",JSON.stringify(s))}catch(e){console.log("Error updating session with handover flag:",e)}return(o=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:t.sender+" has entered the chat",sender:"system",isWelcomeMessage:!1,isSystemNotification:!0,notificationType:"joined",created_at:z(t.created_at||(new Date).toISOString())}),localStorage.setItem("simple-chat-messages",JSON.stringify(o)),void B()}if("ai"!==t.sender_type&&"ai"!==t.sender&&"bot"!==t.sender_type&&"bot"!==t.sender||d){if("sales_rep"===t.sender_type||"sales_rep"===t.sender){if(!(l=t.content||"")||!l.trim())return void console.log("Ignoring empty sales_rep message:",t);(o=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:l,sender:t.sender_type,senderName:t.sender||t.sender_name||"Sales Representative",isWelcomeMessage:!1,created_at:z(t.created_at)}),localStorage.setItem("simple-chat-messages",JSON.stringify(o)),B()}}else{console.log(t,"my message Data");var o,r=(o=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"))[o.length-1];!r||""!==r.text||"bot"!==r.sender&&"ai"!==r.sender||(o.pop(),r=o[o.length-1]||null);var l=t.content||t.message||"";if(!0===t.is_complete&&""===l)return void(r&&r.isStreaming&&(r.isStreaming=!1,o[o.length-1]=r,localStorage.setItem("simple-chat-messages",JSON.stringify(o)),B()));l&&(!r||"bot"!==r.sender&&"ai"!==r.sender||!0!==r.isStreaming?o.push({text:l,sender:"bot",isWelcomeMessage:!1,isStreaming:!0,messageId:t.message_id,created_at:z(t.created_at)}):(r.text+=l,o[o.length-1]=r),console.log(o,"my messages"),localStorage.setItem("simple-chat-messages",JSON.stringify(o)),B())}}},l.onclose=function(){console.error("WebSocket connection closed unexpectedly..."),a=!1,l=null},l.onerror=function(e){console.error("WebSocket error:",e),a=!1,l=null}}catch(e){console.error("Failed to create WebSocket connection:",e),a=!1,l=null}}}function z(e){const t=new Date(e);console.log(t,"createdAT");return t.toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0})}function j(){var e=T.value.trim();if(e)if(R(e,"user"),T.value="",B(),d||(R("","bot"),B()),a&&l&&l.readyState===WebSocket.OPEN)try{l.send(JSON.stringify({message:e,message_type:"text"}))}catch(e){console.error("Error sending message:",e);var t=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");t.length>0&&""===t[t.length-1].text&&t.pop(),t.push({text:"Error sending message. Please try again.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(t)),B()}else{W();var n=function(){if(l&&l.readyState===WebSocket.OPEN)l.send(JSON.stringify({message:e,message_type:"text"}));else if(l&&l.readyState===WebSocket.CONNECTING)setTimeout(n,100);else{var t=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");t.length>0&&""===t[t.length-1].text&&t.pop(),t.push({text:"Error: Could not connect to chat service.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(t)),B()}};setTimeout(n,500)}}function J(){E.style.display="flex",E.style.flexDirection="row",E.style.width="100%",E.style.boxSizing="border-box",E.style.padding="0.5rem",E.style.gap="0",E.style.alignItems="stretch",E.style.flex="0 0 auto",E.style.borderTop="1px solid #ececec",E.style.background="#ffffff",T.style.flex="1 1 0%",T.style.minWidth="0",T.style.width="auto",T.style.margin="0",T.style.height="2.5rem",T.style.padding="0 1rem",T.style.border="1px solid #ececec",T.style.borderRight="none",T.style.borderRadius="0.75rem 0 0 0.75rem",T.style.background=n.inputBg,T.style.color=n.inputText,T.style.fontSize="1rem",T.style.boxSizing="border-box",T.style.outline="none",T.style.transition="border 0.15s ease-in-out",M.style.flex="0 0 auto",M.style.margin="0",M.style.height="2.5rem",M.style.padding="0 1.25rem",M.style.background=n.sendBtnBg,M.style.color=n.sendBtnText,M.style.border="1px solid #ececec",M.style.borderLeft="none",M.style.borderRadius="0 0.75rem 0.75rem 0",M.style.cursor="pointer",M.style.fontWeight="600",M.style.fontSize="1rem",M.style.transition="background 0.15s ease-in-out, color 0.15s ease-in-out",M.style.boxSizing="border-box",M.style.display="flex",M.style.justifyContent="center",M.style.alignItems="center"}function $(e){return String(e).replace(/[&<>"']/g,(function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]}))}M.title="Send",M.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>',M.style.padding="0.75rem",M.style.background=n.sendBtnBg||"#3b82f6",M.style.color="#ffffff",M.style.border="none",M.style.borderRadius="0.375rem",M.style.cursor="pointer",M.style.display="flex",M.style.alignItems="center",M.style.justifyContent="center",M.style.transition="background-color 0.2s ease-in-out",M.addEventListener("mouseover",(function(){M.style.backgroundColor=n.sendBtnHover||"#2563eb"})),M.addEventListener("mouseout",(function(){M.style.backgroundColor=n.sendBtnBg||"#3b82f6"})),I.appendChild(T),I.appendChild(M),E.appendChild(I),y.appendChild(E),document.body.appendChild(y),w.addEventListener("scroll",(function(){H()})),M.onclick=j,T.addEventListener("keydown",(function(e){"Enter"===e.key&&j()}));var D=document.createElement("button");function F(){window.innerWidth,D.style.bottom="20px",D.style.right="20px"}D.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle-icon lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>',D.style.position="fixed",D.style.bottom="20px",D.style.right="20px",D.style.width="80px",D.style.height="80px",D.style.borderRadius="50%",D.style.backgroundColor=n.sendBtnBg||"#16a34a",D.style.color="#ffffff",D.style.border="none",D.style.cursor="pointer",D.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",D.style.display="flex",D.style.alignItems="center",D.style.justifyContent="center",D.style.transition="all 0.3s ease",D.style.zIndex=n.zIndex-1,F(),window.addEventListener("resize",F),y.style.display="none";var A=!1;D.addEventListener("click",(function(){(A=!A)?(y.style.display="flex",D.style.display="none",setTimeout((function(){O()}),150)):(y.style.display="none",D.style.display="flex")})),x.onclick=function(){A=!1,y.style.display="none",D.style.display="flex"},document.body.appendChild(D),window.saveMessage=R,window.loadMessages=B,window.generateChatId=m,window.generateSecureWsParams=c,window.connectWebSocket=W;const P=async(e,n,s)=>{try{var o=null,r=null;"wss://hub.memox.io"===t.socketUrl?(o="https://hub.memox.io/api/v1/",r="eedb5fc2b457815409e45f3b1dc023c276c9cedb"):(o="http://localhost:8000/api/v1/",r="cbacbe059689c3dec8173c05d806c7266b50176e");const l=await fetch(`${o}visitors/?email=${n}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Token ${r} `}}),a=await l.json();if("Not found."!==a.detail&&a.length)i={id:a[0].id,name:a[0].name},console.log(i,"visitorInfo");else{const t=await fetch(`${o}visitors/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Token ${r} `},body:JSON.stringify({name:e,email:n,phone_number:s})});if(!t.ok)throw new Error(`Failed to create visitor: ${t.status}`);const l=await t.json();console.log(l,"visitorData"),i={id:l.id,name:l.name}}}catch(t){console.error("Error creating/fetching visitor:",t),i={id:"offline_"+Date.now(),name:e}}};!function(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"),t=localStorage.getItem("simple-chat-session");if(e.length>0&&t){window.__simpleChatEmbedLeadCaptured=!0;try{var r=JSON.parse(t);i=r.visitorInfo,!0===r.handoverOccurred&&(d=!0,console.log("Restored handover status from session data"))}catch(e){console.log("Error parsing session data:",e)}return J(),B(),setTimeout((function(){O()}),200),void W()}window.__simpleChatEmbedLeadCaptured?(J(),B()):(E.style.display="none",function(e){w.innerHTML="";var t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.height="100%",t.style.width="100%",t.style.gap="1.5rem";var s=document.createElement("div");s.style.width="100%",s.style.maxWidth="300px",s.style.display="flex",s.style.flexDirection="column",s.style.gap="1.5rem";var r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="0.5rem";var l=document.createElement("div");l.style.display="flex",l.style.alignItems="center",l.style.gap="1.5rem";var a=document.createElement("label");a.innerText="Full Name:*",a.style.width="27%",a.style.fontSize="0.875rem",a.style.fontWeight="500",a.style.color="#374151";var d=document.createElement("input");d.type="text",d.placeholder="Full name",d.style.width="60%",d.style.padding="0.75rem 1rem",d.style.border="1px solid #d1d5db",d.style.borderRadius="0.375rem",d.style.fontSize="0.875rem",d.style.outline="none",d.style.transition="border-color 0.2s ease-in-out",d.addEventListener("focus",(function(){d.style.borderColor="#3b82f6"})),d.addEventListener("blur",(function(){d.style.borderColor="#d1d5db"})),l.appendChild(a),l.appendChild(d);var y=document.createElement("div");y.style.display="none",y.style.color="#ef4444",y.style.fontSize="0.75rem",y.style.marginLeft="27%",y.style.paddingLeft="1.5rem",y.innerText="Full name is required",r.appendChild(l),r.appendChild(y);var p=document.createElement("div");p.style.display="flex",p.style.flexDirection="column",p.style.gap="0.5rem";var u=document.createElement("div");u.style.display="flex",u.style.alignItems="center",u.style.gap="1.5rem";var f=document.createElement("label");f.innerText="Email:*",f.style.width="27%",f.style.fontSize="0.875rem",f.style.fontWeight="500",f.style.color="#374151";var g=document.createElement("input");g.type="email",g.placeholder="Email",g.style.width="60%",g.style.padding="0.75rem 1rem",g.style.border="1px solid #d1d5db",g.style.borderRadius="0.375rem",g.style.fontSize="0.875rem",g.style.outline="none",g.style.transition="border-color 0.2s ease-in-out",g.addEventListener("focus",(function(){g.style.borderColor="#3b82f6"})),g.addEventListener("blur",(function(){g.style.borderColor="#d1d5db"})),u.appendChild(f),u.appendChild(g);var h=document.createElement("div");h.style.display="none",h.style.color="#ef4444",h.style.fontSize="0.75rem",h.style.marginLeft="27%",h.style.paddingLeft="1.5rem",h.innerText="Please enter a valid email address",p.appendChild(u),p.appendChild(h);var b=document.createElement("div");b.style.display="flex",b.style.flexDirection="column",b.style.gap="0.5rem";var x=document.createElement("div");x.style.display="flex",x.style.alignItems="center",x.style.gap="1.5rem";var v=document.createElement("label");v.innerText="Phone:*",v.style.width="27%",v.style.fontSize="0.875rem",v.style.fontWeight="500",v.style.color="#374151";var S=document.createElement("input");S.type="tel",S.placeholder="Phone number",S.maxLength=20,S.style.width="60%",S.style.padding="0.75rem 1rem",S.style.border="1px solid #d1d5db",S.style.borderRadius="0.375rem",S.style.fontSize="0.875rem",S.style.outline="none",S.style.transition="border-color 0.2s ease-in-out",S.addEventListener("focus",(function(){S.style.borderColor="#3b82f6"})),S.addEventListener("blur",(function(){S.style.borderColor="#d1d5db"})),x.appendChild(v),x.appendChild(S);var k=document.createElement("div");k.style.display="none",k.style.color="#ef4444",k.style.fontSize="0.75rem",k.style.marginLeft="27%",k.style.paddingLeft="1.5rem",k.innerText="Phone number is required",b.appendChild(x),b.appendChild(k),s.appendChild(r),s.appendChild(p),s.appendChild(b);var C=document.createElement("button");C.innerText="Start Chat",C.style.width="100%",C.style.maxWidth="300px",C.style.padding="0.75rem 1.5rem",C.style.background=n.sendBtnBg||"#16a34a",C.style.color="#ffffff",C.style.border="none",C.style.borderRadius="0.375rem",C.style.cursor="pointer",C.style.fontWeight="600",C.style.fontSize="0.875rem",C.style.transition="background-color 0.2s ease-in-out",C.addEventListener("mouseover",(function(){C.style.backgroundColor=n.sendBtnHover||"#15803d"})),C.addEventListener("mouseout",(function(){C.style.backgroundColor=n.sendBtnBg||"#16a34a"})),C.onclick=async function(){var t=d.value.trim(),n=g.value.trim(),s=S.value.trim(),r=!1;if(d.style.borderColor="#d1d5db",g.style.borderColor="#d1d5db",S.style.borderColor="#d1d5db",y.style.display="none",h.style.display="none",k.style.display="none",t||(d.style.borderColor="#ef4444",y.style.display="block",r=!0),n?/^\S+@\S+\.\S+$/.test(n)||(g.style.borderColor="#ef4444",h.innerText="Please enter a valid email address",h.style.display="block",r=!0):(g.style.borderColor="#ef4444",h.innerText="Email is required",h.style.display="block",r=!0),s?s.length>20?(S.style.borderColor="#ef4444",k.innerText="Phone number must be 20 characters or less",k.style.display="block",r=!0):/^[\+]?[0-9\s\-\(\)\.]{1,20}$/.test(s)||(S.style.borderColor="#ef4444",k.innerText="Please enter a valid phone number",k.style.display="block",r=!0):(S.style.borderColor="#ef4444",k.innerText="Phone number is required",k.style.display="block",r=!0),r)t?n&&/^\S+@\S+\.\S+$/.test(n)?(!s||s.length>20||!/^[\+]?[0-9\s\-\(\)\.]{1,20}$/.test(s))&&S.focus():g.focus():d.focus();else{w.innerHTML="",await P($(d.value),$(g.value),$(S.value));var l=m(),a=o,p=await c(a),u={chatID:l,workflowId:a,hashedWorkflowId:p.hashed_workflow_id,hash:p.hash,visitorInfo:i,timestamp:(new Date).toISOString()};localStorage.setItem("simple-chat-session",JSON.stringify(u));var f=navigator.userAgent,b=navigator.platform,x=window.location.href,v=(new Date).toISOString(),C=navigator.language,E=document.referrer;fetch("https://api.ipify.org?format=json").then((function(e){return e.json()})).then((function(t){var n=t.ip||"",s=localStorage.getItem("simple-chat-user-guid");s||(s=([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,(e=>(e^crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16))),localStorage.setItem("simple-chat-user-guid",s));var o={name:$(d.value),email:$(g.value),phone:$(S.value),timestamp:v,userAgent:f,platform:b,url:x,language:C,referrer:E,guid:s,ip:n},r=JSON.parse(localStorage.getItem("simple-chat-leads")||"[]");r.push(o),localStorage.setItem("simple-chat-leads",JSON.stringify(r)),e(o)})).catch((function(){var t={name:$(d.value),email:$(g.value),phone:$(S.value),timestamp:(new Date).toISOString(),userAgent:navigator.userAgent,platform:navigator.platform,url:window.location.href,language:navigator.language,referrer:document.referrer,guid:localStorage.getItem("simple-chat-user-guid")||"unknown",ip:""},n=JSON.parse(localStorage.getItem("simple-chat-leads")||"[]");n.push(t),localStorage.setItem("simple-chat-leads",JSON.stringify(n)),e(t)}))}},d.addEventListener("keydown",(function(e){"Enter"===e.key&&C.click()})),g.addEventListener("keydown",(function(e){"Enter"===e.key&&C.click()})),S.addEventListener("keydown",(function(e){"Enter"===e.key&&C.click()})),t.appendChild(s),t.appendChild(C),w.appendChild(t),d.focus()}((function(e){window.__simpleChatEmbedLeadCaptured=!0,e&&(window.SimpleChatEmbedLead=e),J();JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");s&&R(s,"bot","welcomeMessage"),B()})))}(),setTimeout((function(){var e=localStorage.getItem("simple-chat-session");if(e)try{var t=JSON.parse(e),n=new Date-new Date(t.timestamp);t.chatID&&t.workflowId&&t.hashedWorkflowId&&t.hash&&t.visitorInfo&&n<864e5&&(i=t.visitorInfo,a||l||W())}catch(e){console.log("Error checking stored session for auto-connect:",e)}}),100)}();