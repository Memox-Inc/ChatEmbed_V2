(()=>{var e;function t(){var e={title:"Chat",theme:{primary:"#0078d4",userBubble:"#e6f0fa",botBubble:"#f1f1f1",userText:"#22223b",botText:"#4a4e69",background:"#fff",border:"#ccc",text:"#222",width:"100%",maxWidth:"350px",minWidth:"220px",borderRadius:"8px",fontFamily:"sans-serif",zIndex:9999,headerText:"#fff",headerBg:"rgba(34, 34, 59, 0.95)",inputBg:"#fff",inputText:"#222",sendBtnBg:"#0078d4",sendBtnText:"#fff",sendBtnHover:"#005fa3",shadow:"0 2px 8px rgba(0,0,0,0.15)",salesRepBubble:"#f1f5f9",salesRepText:"#475569",salesRepAvatar:"#E4E7FC",userAvatar:"#8349ff",botAvatar:"#E4E7FC",handoverNotificationBg:"#E4E7FC",handoverNotificationText:"#334155",handoverNotificationBorder:"#8349FF"}},a=window.SimpleChatEmbedConfig?{...e,...window.SimpleChatEmbedConfig,theme:{...e.theme,...window.SimpleChatEmbedConfig.theme||{}}}:e,h=a.theme,s=a.welcomeMessage||null,R=a.workflowId,j=a.socketUrl+"/ws/chat/",r=null,i=!1,d=null,f=!1;function z(e){let t=btoa(String(e));var e=new TextEncoder,n=e.encode("4f3c9a1d8e5b6c2f719a0e3d5a8b7c4d9e6f1a0b3d7c8e2f6a9d0e1b4c5f7a6d");let s=e.encode(t);return window.crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then(e=>window.crypto.subtle.sign("HMAC",e,s)).then(e=>{e=Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("");return{hashed_workflow_id:t,hash:e}})}function J(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}var t=document.createElement("div");function D(){window.innerWidth<768?(t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.right="0",t.style.bottom="0",t.style.width="100%",t.style.height="100vh",t.style.borderRadius="0",t.style.maxHeight="100vh"):(t.style.position="fixed",t.style.top="auto",t.style.left="auto",t.style.right="20px",t.style.bottom="20px",t.style.width="384px",t.style.height="80vh",t.style.borderRadius="0.75rem",t.style.maxHeight="600px")}t.id="simple-chat-embed",t.style.position="fixed",t.style.bottom="20px",t.style.right="20px",t.style.width="384px",t.style.height="80vh",t.style.maxHeight="600px",t.style.background="#ffffff",t.style.border="1px solid #e2e8f0",t.style.borderRadius="0.75rem",t.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",t.style.fontFamily=h.fontFamily+", Inter, system-ui, sans-serif",t.style.zIndex=h.zIndex,t.style.color=h.text,t.style.transition="transform 0.3s ease-in-out",t.style.display="flex",t.style.flexDirection="column",t.style.overflow="hidden",D(),window.addEventListener("resize",D);var e=document.createElement("div"),n=(e.style.display="flex",e.style.justifyContent="space-between",e.style.alignItems="center",e.style.background=h.headerBg||"#16a34a",e.style.color=h.headerText,e.style.padding="2rem",e.style.borderTopLeftRadius="0.75rem",e.style.borderTopRightRadius="0.75rem",e.style.fontWeight="600",e.style.fontSize="1.125rem",e.style.lineHeight="1.75rem",document.createElement("div")),n=(n.innerText=a.title,e.appendChild(n),document.createElement("div")),o=(n.style.display="flex",document.createElement("button")),l=(o.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="m21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>',o.title="Reset chat",o.style.background="transparent",o.style.color=h.headerText,o.style.border="none",o.style.padding="0.5rem",o.style.cursor="pointer",o.style.borderRadius="0.375rem",o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="center",o.style.transition="background-color 0.2s ease-in-out",o.onmouseover=function(){o.style.backgroundColor="rgba(255,255,255,0.1)"},o.onmouseout=function(){o.style.backgroundColor="transparent"},o.onclick=function(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]").some(function(e){return e.isSystemNotification&&"joined"===e.notificationType}),t=localStorage.getItem("simple-chat-session"),n=!1;if(t)try{n=!0===JSON.parse(t).handoverOccurred}catch(e){console.log("Error reading session handover flag:",e)}localStorage.removeItem("simple-chat-messages"),f=!(!e&&!n),k(),s&&x(s,"bot","welcomeMessage"),b()},document.createElement("button")),c=(l.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',l.title="Close chat",l.style.background="transparent",l.style.color=h.headerText,l.style.border="none",l.style.padding="0.5rem",l.style.cursor="pointer",l.style.borderRadius="0.375rem",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.transition="background-color 0.2s ease-in-out",l.onmouseover=function(){l.style.backgroundColor="rgba(255,255,255,0.1)"},l.onmouseout=function(){l.style.backgroundColor="transparent"},l),n=(n.appendChild(o),n.appendChild(l),e.appendChild(n),document.createElement("div")),g=(n.style.height="1px",n.style.background="#e2e8f0",n.style.marginBottom="1rem",t.appendChild(e),t.appendChild(n),document.createElement("div")),e=(g.style.flex="1 1 0%",g.style.overflowY="auto",g.style.overflowX="hidden",g.style.padding="1rem",g.style.background="#ffffff",g.id="chat-messages",g.style.display="flex",g.style.flexDirection="column",g.style.gap="1rem",g.style.scrollBehavior="smooth",g.style.scrollbarWidth="none",g.style.msOverflowStyle="none",document.createElement("style")),y=(e.textContent=`
        #chat-messages::-webkit-scrollbar { display: none; }
        #simple-chat-embed ul { list-style-type: disc !important; }
        #simple-chat-embed ol { list-style-type: decimal !important; }
        #simple-chat-embed ul li::marker { color: #6b7280; }
        #simple-chat-embed ol li::marker { color: #6b7280; font-weight: 600; }
        #simple-chat-embed pre { white-space: pre-wrap; word-wrap: break-word; }
        #simple-chat-embed code { word-wrap: break-word; }
        #simple-chat-embed blockquote { 
            border-left: 4px solid #e5e7eb; 
            padding-left: 1rem; 
            margin: 1rem 0; 
            color: #6b7280; 
            font-style: italic; 
        }
    `,document.head.appendChild(e),t.appendChild(g),document.createElement("button")),n=(y.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 13 5 5 5-5"/><path d="M12 18V6"/></svg>',y.title="Scroll to bottom",y.style.position="absolute",y.style.right="1rem",y.style.bottom="5rem",y.style.width="40px",y.style.height="40px",y.style.borderRadius="50%",y.style.background=h.sendBtnBg||"#3b82f6",y.style.color="#ffffff",y.style.border="none",y.style.cursor="pointer",y.style.display="none",y.style.alignItems="center",y.style.justifyContent="center",y.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",y.style.transition="all 0.3s ease",y.style.zIndex="10",y.addEventListener("mouseover",function(){y.style.backgroundColor=h.sendBtnHover||"#2563eb",y.style.transform="scale(1.1)"}),y.addEventListener("mouseout",function(){y.style.backgroundColor=h.sendBtnBg||"#3b82f6",y.style.transform="scale(1)"}),y.onclick=function(){g.scrollTop=g.scrollHeight,y.style.display="none"},t.appendChild(y),document.createElement("div")),m=(n.style.height="1px",n.style.background="#e2e8f0",n.style.marginTop="1rem",document.createElement("div")),e=(m.style.padding="1rem",m.style.background="#ffffff",m.style.display="flex",m.style.flexDirection="column",m.style.borderBottomLeftRadius="0.75rem",m.style.borderBottomRightRadius="0.75rem",t.appendChild(n),t.appendChild(m),document.createElement("div")),p=(e.style.display="grid",e.style.gridTemplateColumns="1fr auto",e.style.gap="1rem",e.style.alignItems="center",e.style.width="100%",document.createElement("input")),u=(p.type="text",p.placeholder="Type your message...",p.style.padding="0.75rem 1rem",p.style.border="1px solid #d1d5db",p.style.borderRadius="0.375rem",p.style.background="#ffffff",p.style.color="#374151",p.style.fontSize="0.875rem",p.style.lineHeight="1.25rem",p.style.outline="none",p.style.transition="border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out",p.addEventListener("focus",function(){p.style.borderColor="#3b82f6",p.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.1)"}),p.addEventListener("blur",function(){p.style.borderColor="#d1d5db",p.style.boxShadow="none"}),document.createElement("button"));function F(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function b(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");g.innerHTML="",e.some(function(e){return e.isSystemNotification&&"joined"===e.notificationType})&&(f=!0);for(var t,n=0;n<e.length;n++){var s,o,l,r,i,a,d,c,y,m,p,u=e[n];u.isSystemNotification?((l=document.createElement("div")).style.display="flex",l.style.justifyContent="center",l.style.margin="1rem 0",l.style.animation="fadeInUp 0.5s ease-out",o=((s=document.createElement("div")).style.background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",s.style.color="#ffffff",s.style.padding="0.75rem 1.5rem",s.style.borderRadius="20px",s.style.fontSize="0.875rem",s.style.fontWeight="500",s.style.display="flex",s.style.alignItems="center",s.style.gap="0.5rem",s.style.maxWidth="80%",s.style.textAlign="center",document.createElement("span")),"joined"===u.notificationType?(o.innerHTML="ðŸ‘‹",s.style.background=h.handoverNotificationBg||"#E4E7FC",s.style.color=h.handoverNotificationText||"#334155",s.style.border="1px solid "+(h.handoverNotificationBorder||"#8349FF")):o.innerHTML="ðŸ’¬",o.style.fontSize="1rem",s.appendChild(o),s.appendChild(document.createTextNode(u.text)),l.appendChild(s),document.getElementById("system-notification-style")||((o=document.createElement("style")).id="system-notification-style",o.innerHTML=`
                        @keyframes fadeInUp {
                            0% { opacity: 0; transform: translateY(20px); }
                            100% { opacity: 1; transform: translateY(0); }
                        }
                    `,document.head.appendChild(o)),g.appendChild(l)):((s=document.createElement("div")).style.display="flex",s.style.flexDirection="column",s.style.marginBottom="1rem",l=((o=document.createElement("div")).style.display="flex",o.style.gap="0.5rem","user"===u.sender&&(o.style.flexDirection="row-reverse",o.style.justifyContent="flex-start"),null),"user"===u.sender?((l=document.createElement("div")).style.width="40px",l.style.height="40px",l.style.borderRadius="50%",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.background=h.userAvatar||"#8349ff",(r=document.createElement("div")).innerHTML=`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 21V19C19 17.9391 18.5786 16.9217 17.8284 16.1716C17.0783 15.4214 16.0609 15 15 15H9C7.93913 15 6.92172 15.4214 6.17157 16.1716C5.42143 16.9217 5 17.9391 5 19V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                `,l.appendChild(r)):"sales_rep"===u.sender?((l=document.createElement("div")).style.width="40px",l.style.height="40px",l.style.borderRadius="50%",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.background=h.salesRepAvatar||"#E4E7FC",i=h.primary||"#8349FF",l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" style="width:26px;height:26px;color:'+i+';" width="200" height="200" viewBox="0 0 24 24"><path fill="currentColor" d="M19.938 8H21a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1.062A8.001 8.001 0 0 1 12 23v-2a6 6 0 0 0 6-6V9A6 6 0 0 0 6 9v7H3a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1.062a8.001 8.001 0 0 1 15.876 0ZM3 10v4h1v-4H3Zm17 0v4h1v-4h-1ZM7.76 15.785l1.06-1.696A5.972 5.972 0 0 0 12 15a5.972 5.972 0 0 0 3.18-.911l1.06 1.696A7.963 7.963 0 0 1 12 17a7.962 7.962 0 0 1-4.24-1.215Z"/></svg>'):"bot"!==u.sender&&"ai"!==u.sender||((l=document.createElement("div")).style.width="40px",l.style.height="40px",l.style.borderRadius="50%",l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="center",l.style.background=h.botAvatar||"#E4E7FC",r=document.createElement("div"),i=h.primary||"#8349ff",r.innerHTML=`
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_4_4929)">
                            <path d="M19 11H5C3.89543 11 3 11.8954 3 13V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V13C21 11.8954 20.1046 11 19 11Z" stroke="${i}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 7C13.1046 7 14 6.10457 14 5C14 3.89543 13.1046 3 12 3C10.8954 3 10 3.89543 10 5C10 6.10457 10.8954 7 12 7Z" stroke="${i}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M12 7V11" stroke="${i}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </g>
                        <defs>
                            <clipPath id="clip0_4_4929">
                                <rect width="24" height="24" fill="white"/>
                            </clipPath>
                        </defs>
                    </svg>
                `,l.appendChild(r)),(a=document.createElement("div")).style.display="flex",a.style.flexDirection="column",a.style.gap="0.5rem",a.style.maxWidth=(u.sender,"70%"),(d=document.createElement("div")).style.padding="0.75rem 1rem",d.style.wordBreak="break-word",d.style.fontSize="0.875rem",d.style.lineHeight="1.25rem",d.style.position="relative","user"===u.sender?(d.style.backgroundColor=h.userBubble||"#dbeafe",d.style.color=h.userText||"#1e40af",d.style.alignSelf="flex-end",d.style.borderRadius="1rem 1rem 0.25rem 1rem",d.style.boxShadow="0 2px 8px rgba(59, 130, 246, 0.15)"):"sales_rep"===u.sender?(d.style.background=h.salesRepBubble||"#f1f5f9",d.style.color=h.salesRepText||"#475569",d.style.alignSelf="flex-start",d.style.borderRadius="1rem 1rem 1rem 0.25rem"):(d.style.backgroundColor=h.botBubble||"#f1f5f9",d.style.color=h.botText||"#475569",d.style.alignSelf="flex-start",d.style.borderRadius="1rem 1rem 1rem 0.25rem",d.style.boxShadow="0 2px 8px rgba(71, 85, 105, 0.1)"),""===u.text&&n===e.length-1?d.appendChild((t=c=void 0,(c=document.createElement("span")).style.display="inline-flex",c.style.alignItems="center",c.style.height="1.5em",t=h.botText||"#4a4e69",c.innerHTML=`
      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s infinite alternate;"></span>
      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.2s infinite alternate;"></span>
      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.4s infinite alternate;"></span>
    `,document.getElementById("simple-chat-bounce-style")||((t=document.createElement("style")).id="simple-chat-bounce-style",t.innerHTML="@keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-7px); } }",document.head.appendChild(t)),c)):"[Image]"===u.text&&0<n&&"string"==typeof(t=e[n-1].text)&&t.startsWith("data:image/")?((c=document.createElement("img")).src=e[n-1].text,c.style.maxWidth="200px",c.style.maxHeight="150px",c.style.borderRadius="0.5rem",c.style.display="block",d.appendChild(c)):(y=document.createElement("div"),"bot"===u.sender||"ai"===u.sender?y.innerHTML=(t=>{if(!t)return"";try{if("undefined"==typeof marked)throw new Error("marked.js not available");var e=marked.parse(t,{breaks:!0,gfm:!0});return"string"==typeof e?e=(e=(e=(e=(e=(e=(e=(e=e.replace(/<a\s+href="([^"]*)"([^>]*)>([^<]*)<\/a>/g,function(e,t,n,s){return'<a href="'+t+'" target="_blank" style="font-weight:bold;color:'+(h.botText||"#4a4e69")+';text-decoration:underline;cursor:pointer;">'+s+"</a>"})).replace(/<ul>/g,'<ul style="margin:8px 0;padding-left:24px;">')).replace(/<ol>/g,'<ol style="margin:8px 0;padding-left:24px;">')).replace(/<li>/g,'<li style="margin:4px 0;">')).replace(/<pre><code>/g,"<pre style=\"background:#f6f8fa;border:1px solid #e1e4e8;border-radius:6px;padding:16px;margin:8px 0;overflow-x:auto;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:13px;line-height:1.45;\"><code>")).replace(/<code>/g,"<code style=\"background:#f6f8fa;border-radius:3px;padding:2px 4px;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:85%;\">")).replace(/<strong>/g,'<strong style="font-weight:600;">')).replace(/<em>/g,'<em style="font-style:italic;">'):String(e)}catch(e){return console.error("Markdown parsing error:",e),F(t).replace(/\n/g,"<br>")}})(u.text):"sales_rep"===u.sender?(m=F(u.text).replace(/\n/g,"<br>"),p="Sales Representative",u.senderName&&("string"==typeof u.senderName?p=u.senderName:u.senderName.name&&(p=u.senderName.name)),y.innerHTML='<div style=" padding-bottom: 6px; font-size: 0.75rem; color: #6b7280; font-weight: 500;">~ '+p+"</div>"+m,y.style.fontWeight="500",y.style.lineHeight="1.4",y.style.display="block",y.style.width="100%"):y.innerHTML=F(u.text).replace(/\n/g,"<br>"),d.appendChild(y)),a.appendChild(d),u.isWelcomeMessage||((p=document.createElement("div")).style.fontSize="0.75rem",p.style.color="#9ca3af",p.style.alignSelf="user"===u.sender?"flex-end":"flex-start",p.innerText=u.created_at,a.appendChild(p)),l&&o.appendChild(l),o.appendChild(a),s.appendChild(o),g.appendChild(s))}g.scrollTop=g.scrollHeight,setTimeout(function(){g.scrollTop=g.scrollHeight,A()},100)}function A(){var e=g.scrollHeight-g.scrollTop<=g.clientHeight+100;y.style.display=e?"none":"flex"}function $(){var t=0;!function e(){g.scrollTop=g.scrollHeight,++t<5&&g.scrollTop<g.scrollHeight-g.clientHeight-10?setTimeout(e,50):A()}()}function x(e,t,n=""){var s=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");"welcomeMessage"===n?-1!==(n=s.findIndex(e=>e.isWelcomeMessage))?s[n].text=e:s.push({text:e,isWelcomeMessage:!0,sender:t}):s.push({text:e,isWelcomeMessage:!1,sender:t,created_at:v((new Date).toISOString())}),localStorage.setItem("simple-chat-messages",JSON.stringify(s))}async function w(){if(!i&&!r){var e,t,n,s=localStorage.getItem("simple-chat-session");if(s)try{var o=JSON.parse(s),l=new Date-new Date(o.timestamp);if(!(o.chatID&&o.workflowId&&o.hashedWorkflowId&&o.hash&&o.visitorInfo&&l<864e5))throw new Error("Invalid or expired session");e=o.chatID,t=o.workflowId,n={hashed_workflow_id:o.hashedWorkflowId,hash:o.hash},d=o.visitorInfo}catch(e){console.log("Invalid session data, generating new session"),localStorage.removeItem("simple-chat-session"),s=null}s||(e=J(),n=await z(t=R),d&&(l={chatID:e,workflowId:t,hashedWorkflowId:n.hashed_workflow_id,hash:n.hash,visitorInfo:d,timestamp:(new Date).toISOString()},localStorage.setItem("simple-chat-session",JSON.stringify(l))));o=""+j+e+`/?workflow_id=${n.hashed_workflow_id}&hash=${n.hash}&visitorInfo=`+JSON.stringify(d);try{(r=new WebSocket(o)).onopen=function(){i=!0},r.onmessage=function(e){var t,e=JSON.parse(e.data);if("unread_message"!==e?.message_type)if("handover_message"===e?.message_type){f=!0;var n=localStorage.getItem("simple-chat-session");if(n)try{var s=JSON.parse(n);s.handoverOccurred=!0,localStorage.setItem("simple-chat-session",JSON.stringify(s))}catch(e){console.log("Error updating session with handover flag:",e)}(n=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:e.sender+" has entered the chat",sender:"system",isWelcomeMessage:!1,isSystemNotification:!0,notificationType:"joined",created_at:v(e.created_at||(new Date).toISOString())}),localStorage.setItem("simple-chat-messages",JSON.stringify(n)),b()}else"ai"!==e.sender_type&&"ai"!==e.sender&&"bot"!==e.sender_type&&"bot"!==e.sender||f?"sales_rep"!==e.sender_type&&"sales_rep"!==e.sender||(t=e.content||"")&&t.trim()&&((n=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:t,sender:e.sender_type,senderName:e.sender||e.sender_name||"Sales Representative",isWelcomeMessage:!1,created_at:v(e.created_at)}),localStorage.setItem("simple-chat-messages",JSON.stringify(n)),b()):(!(s=(n=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"))[n.length-1])||""!==s.text||"bot"!==s.sender&&"ai"!==s.sender||(n.pop(),s=n[n.length-1]||null),t=e.content||e.message||"",!0===e.is_complete&&""===t?s&&s.isStreaming&&(console.log("Stream completed"),s.isStreaming=!1,n[n.length-1]=s,localStorage.setItem("simple-chat-messages",JSON.stringify(n))):t&&(!s||"bot"!==s.sender&&"ai"!==s.sender||!0!==s.isStreaming?n.push({text:t,sender:"bot",isWelcomeMessage:!1,isStreaming:!0,messageId:e.message_id,created_at:v(e.created_at),lastChunkTime:Date.now()}):(s.text+=t,s.lastChunkTime=Date.now(),n[n.length-1]=s),localStorage.setItem("simple-chat-messages",JSON.stringify(n)),b()))},r.onclose=function(){console.error("WebSocket connection closed unexpectedly..."),i=!1,r=null},r.onerror=function(e){console.error("WebSocket error:",e),i=!1,r=null}}catch(e){console.error("Failed to create WebSocket connection:",e),i=!1,r=null}}}function v(e){return new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0})}function P(t){var n=p.value.trim()||t;if(n)if(x(n,"user"),p.value="",b(),f||(x("","bot"),b()),i&&r&&r.readyState===WebSocket.OPEN)try{r.send(JSON.stringify({message:n,message_type:"text"}))}catch(e){console.error("Error sending message:",e);t=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");0<t.length&&""===t[t.length-1].text&&t.pop(),t.push({text:"Error sending message. Please try again.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(t)),b()}else{w();var s=function(){var e;r&&r.readyState===WebSocket.OPEN?r.send(JSON.stringify({message:n,message_type:"text"})):r&&r.readyState===WebSocket.CONNECTING?setTimeout(s,100):(0<(e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).length&&""===e[e.length-1].text&&e.pop(),e.push({text:"Error: Could not connect to chat service.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(e)),b())};setTimeout(s,500)}}function k(){m.style.display="flex",m.style.flexDirection="row",m.style.width="100%",m.style.boxSizing="border-box",m.style.padding="0.5rem",m.style.gap="0",m.style.alignItems="stretch",m.style.flex="0 0 auto",m.style.borderTop="1px solid #ececec",m.style.background="#ffffff",p.style.flex="1 1 0%",p.style.minWidth="0",p.style.width="auto",p.style.margin="0",p.style.height="2.5rem",p.style.padding="0 1rem",p.style.border="1px solid #ececec",p.style.borderRight="none",p.style.borderRadius="0.75rem 0 0 0.75rem",p.style.background=h.inputBg,p.style.color=h.inputText,p.style.fontSize="1rem",p.style.boxSizing="border-box",p.style.outline="none",p.style.transition="border 0.15s ease-in-out",u.style.flex="0 0 auto",u.style.margin="0",u.style.height="2.5rem",u.style.padding="0 1.25rem",u.style.background=h.sendBtnBg,u.style.color=h.sendBtnText,u.style.border="1px solid #ececec",u.style.borderLeft="none",u.style.borderRadius="0 0.75rem 0.75rem 0",u.style.cursor="pointer",u.style.fontWeight="600",u.style.fontSize="1rem",u.style.transition="background 0.15s ease-in-out, color 0.15s ease-in-out",u.style.boxSizing="border-box",u.style.display="flex",u.style.justifyContent="center",u.style.alignItems="center"}function C(e){return String(e).replace(/[&<>"']/g,function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]})}u.title="Send",u.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>',u.style.padding="0.75rem",u.style.background=h.sendBtnBg||"#3b82f6",u.style.color="#ffffff",u.style.border="none",u.style.borderRadius="0.375rem",u.style.cursor="pointer",u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",u.style.transition="background-color 0.2s ease-in-out",u.addEventListener("mouseover",function(){u.style.backgroundColor=h.sendBtnHover||"#2563eb"}),u.addEventListener("mouseout",function(){u.style.backgroundColor=h.sendBtnBg||"#3b82f6"}),e.appendChild(p),e.appendChild(u),m.appendChild(e),t.appendChild(m),document.body.appendChild(t),g.addEventListener("scroll",function(){A()}),u.onclick=P,p.addEventListener("keydown",function(e){"Enter"===e.key&&P()});var S=document.createElement("button");function Z(){window.innerWidth,S.style.bottom="20px",S.style.right="20px"}S.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle-icon lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>',S.style.position="fixed",S.style.bottom="20px",S.style.right="20px",S.style.width="80px",S.style.height="80px",S.style.borderRadius="50%",S.style.backgroundColor=h.sendBtnBg||"#16a34a",S.style.color="#ffffff",S.style.border="none",S.style.cursor="pointer",S.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",S.style.display="flex",S.style.alignItems="center",S.style.justifyContent="center",S.style.transition="all 0.3s ease",S.style.zIndex=h.zIndex-1,Z(),window.addEventListener("resize",Z);var V=!(t.style.display="none");S.addEventListener("click",function(){(V=!V)?(t.style.display="flex",S.style.display="none",setTimeout(function(){$()},150)):(t.style.display="none",S.style.display="flex")}),c.onclick=function(){V=!1,t.style.display="none",S.style.display="flex"},document.body.appendChild(S),window.saveMessage=x,window.loadMessages=b,window.generateChatId=J,window.generateSecureWsParams=z,window.connectWebSocket=w;let q=async(t,e,n)=>{try{var s=null,o=null,o="wss://hub.memox.io"===a.socketUrl?(s="https://hub.memox.io/api/v1/","eedb5fc2b457815409e45f3b1dc023c276c9cedb"):(s="http://localhost:8000/api/v1/","cbacbe059689c3dec8173c05d806c7266b50176e"),l=await(await fetch(s+"visitors/?email="+e,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Token ${o} `}})).json();if("Not found."!==l.detail&&l.length)d={id:l[0].id,name:l[0].name};else{var r=await fetch(s+"visitors/",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Token ${o} `},body:JSON.stringify({name:t,email:e,phone_number:n})});if(!r.ok)throw new Error("Failed to create visitor: "+r.status);var i=await r.json();d={id:i.id,name:i.name}}}catch(e){console.error("Error creating/fetching visitor:",e),d={id:"offline_"+Date.now(),name:t}}};var U,E,I,T,M,L,N,B,_,H,O,n=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"),e=localStorage.getItem("simple-chat-session");if(0<n.length&&e){window.__simpleChatEmbedLeadCaptured=!0;try{var W=JSON.parse(e);d=W.visitorInfo,!0===W.handoverOccurred&&(f=!0)}catch(e){console.log("Error parsing session data:",e)}k(),b(),setTimeout(function(){$()},200),w()}else window.__simpleChatEmbedLeadCaptured?(k(),b()):(m.style.display="none",U=function(e){window.__simpleChatEmbedLeadCaptured=!0,e&&(window.SimpleChatEmbedLead=e),k();JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");s&&x(s,"bot","welcomeMessage"),b()},g.innerHTML="",(n=document.createElement("div")).style.display="flex",n.style.flexDirection="column",n.style.alignItems="center",n.style.justifyContent="center",n.style.height="100%",n.style.width="100%",n.style.gap="1.5rem",(e=document.createElement("div")).style.width="100%",e.style.maxWidth="300px",e.style.display="flex",e.style.flexDirection="column",e.style.gap="1.5rem",(W=document.createElement("div")).style.display="flex",W.style.flexDirection="column",W.style.gap="0.5rem",(c=document.createElement("div")).style.display="flex",c.style.alignItems="center",c.style.gap="1.5rem",(E=document.createElement("label")).innerText="Full Name:*",E.style.width="27%",E.style.fontSize="0.875rem",E.style.fontWeight="500",E.style.color="#374151",(I=document.createElement("input")).type="text",I.placeholder="Full name",I.style.width="60%",I.style.padding="0.75rem 1rem",I.style.border="1px solid #d1d5db",I.style.borderRadius="0.375rem",I.style.fontSize="0.875rem",I.style.outline="none",I.style.transition="border-color 0.2s ease-in-out",I.addEventListener("focus",function(){I.style.borderColor="#3b82f6"}),I.addEventListener("blur",function(){I.style.borderColor="#d1d5db"}),c.appendChild(E),c.appendChild(I),(T=document.createElement("div")).style.display="none",T.style.color="#ef4444",T.style.fontSize="0.75rem",T.style.marginLeft="27%",T.style.paddingLeft="1.5rem",T.innerText="Full name is required",W.appendChild(c),W.appendChild(T),(E=document.createElement("div")).style.display="flex",E.style.flexDirection="column",E.style.gap="0.5rem",(c=document.createElement("div")).style.display="flex",c.style.alignItems="center",c.style.gap="1.5rem",(M=document.createElement("label")).innerText="Email:*",M.style.width="27%",M.style.fontSize="0.875rem",M.style.fontWeight="500",M.style.color="#374151",(L=document.createElement("input")).type="email",L.placeholder="Email",L.style.width="60%",L.style.padding="0.75rem 1rem",L.style.border="1px solid #d1d5db",L.style.borderRadius="0.375rem",L.style.fontSize="0.875rem",L.style.outline="none",L.style.transition="border-color 0.2s ease-in-out",L.addEventListener("focus",function(){L.style.borderColor="#3b82f6"}),L.addEventListener("blur",function(){L.style.borderColor="#d1d5db"}),c.appendChild(M),c.appendChild(L),(N=document.createElement("div")).style.display="none",N.style.color="#ef4444",N.style.fontSize="0.75rem",N.style.marginLeft="27%",N.style.paddingLeft="1.5rem",N.innerText="Please enter a valid email address",E.appendChild(c),E.appendChild(N),(M=document.createElement("div")).style.display="flex",M.style.flexDirection="column",M.style.gap="0.5rem",(c=document.createElement("div")).style.display="flex",c.style.alignItems="center",c.style.gap="1.5rem",(B=document.createElement("label")).innerText="Phone:*",B.style.width="27%",B.style.fontSize="0.875rem",B.style.fontWeight="500",B.style.color="#374151",(_=document.createElement("input")).type="tel",_.placeholder="Phone number",_.maxLength=20,_.style.width="60%",_.style.padding="0.75rem 1rem",_.style.border="1px solid #d1d5db",_.style.borderRadius="0.375rem",_.style.fontSize="0.875rem",_.style.outline="none",_.style.transition="border-color 0.2s ease-in-out",_.addEventListener("focus",function(){_.style.borderColor="#3b82f6"}),_.addEventListener("blur",function(){_.style.borderColor="#d1d5db"}),c.appendChild(B),c.appendChild(_),(H=document.createElement("div")).style.display="none",H.style.color="#ef4444",H.style.fontSize="0.75rem",H.style.marginLeft="27%",H.style.paddingLeft="1.5rem",H.innerText="Phone number is required",M.appendChild(c),M.appendChild(H),e.appendChild(W),e.appendChild(E),e.appendChild(M),(O=document.createElement("button")).innerText="Start Chat",O.style.width="100%",O.style.maxWidth="300px",O.style.padding="0.75rem 1.5rem",O.style.background=h.sendBtnBg||"#16a34a",O.style.color="#ffffff",O.style.border="none",O.style.borderRadius="0.375rem",O.style.cursor="pointer",O.style.fontWeight="600",O.style.fontSize="0.875rem",O.style.transition="background-color 0.2s ease-in-out",O.addEventListener("mouseover",function(){O.style.backgroundColor=h.sendBtnHover||"#15803d"}),O.addEventListener("mouseout",function(){O.style.backgroundColor=h.sendBtnBg||"#16a34a"}),O.onclick=async function(){var e,t,n=I.value.trim(),s=L.value.trim(),o=_.value.trim(),l=!1;I.style.borderColor="#d1d5db",L.style.borderColor="#d1d5db",_.style.borderColor="#d1d5db",T.style.display="none",N.style.display="none",H.style.display="none",n||(I.style.borderColor="#ef4444",T.style.display="block",l=!0),s?/^\S+@\S+\.\S+$/.test(s)||(L.style.borderColor="#ef4444",N.innerText="Please enter a valid email address",N.style.display="block",l=!0):(L.style.borderColor="#ef4444",N.innerText="Email is required",N.style.display="block",l=!0),o?20<o.length?(_.style.borderColor="#ef4444",H.innerText="Phone number must be 20 characters or less",H.style.display="block",l=!0):/^[\+]?[0-9\s\-\(\)\.]{1,20}$/.test(o)||(_.style.borderColor="#ef4444",H.innerText="Please enter a valid phone number",H.style.display="block",l=!0):(_.style.borderColor="#ef4444",H.innerText="Phone number is required",H.style.display="block",l=!0),l?n?s&&/^\S+@\S+\.\S+$/.test(s)?o&&!(20<o.length)&&/^[\+]?[0-9\s\-\(\)\.]{1,20}$/.test(o)||_.focus():L.focus():I.focus():(g.innerHTML="",await q(C(I.value),C(L.value),C(_.value)),n={chatID:J(),workflowId:R,hashedWorkflowId:(l=await z(R)).hashed_workflow_id,hash:l.hash,visitorInfo:d,timestamp:(new Date).toISOString()},localStorage.setItem("simple-chat-session",JSON.stringify(n)),s=navigator.userAgent,o=navigator.platform,l=window.location.href,n=(new Date).toISOString(),e=navigator.language,t=document.referrer,n={name:C(I.value),email:C(L.value),phone:C(_.value),timestamp:n,userAgent:s,platform:o,url:l,language:e,referrer:t,ip:""},(s=JSON.parse(localStorage.getItem("simple-chat-leads")||"[]")).push(n),localStorage.setItem("simple-chat-leads",JSON.stringify(s)),U(n),P(`${I.value} ${L.value} `+_.value))},I.addEventListener("keydown",function(e){"Enter"===e.key&&O.click()}),L.addEventListener("keydown",function(e){"Enter"===e.key&&O.click()}),_.addEventListener("keydown",function(e){"Enter"===e.key&&O.click()}),n.appendChild(e),n.appendChild(O),g.appendChild(n),I.focus());setTimeout(function(){var e=localStorage.getItem("simple-chat-session");if(e)try{var t=JSON.parse(e),n=new Date-new Date(t.timestamp);t.chatID&&t.workflowId&&t.hashedWorkflowId&&t.hash&&t.visitorInfo&&n<864e5&&(d=t.visitorInfo,i||r||w())}catch(e){console.log("Error checking stored session for auto-connect:",e)}},100)}"undefined"==typeof marked?((e=document.createElement("script")).src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js",e.onload=function(){console.log("Marked.js library loaded"),t()},e.onerror=function(){console.warn("Failed to load marked.js from CDN, initializing without it"),t()},document.head.appendChild(e)):t()})();