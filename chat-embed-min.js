!function(){if("undefined"==typeof marked){var e=document.createElement("script");return e.src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js",e.onload=function(){console.log("Marked.js library loaded"),t()},e.onerror=function(){console.warn("Failed to load marked.js from CDN, initializing without it"),t()},void document.head.appendChild(e)}function t(){var e={title:"Chat",theme:{primary:"#0078d4",userBubble:"#e6f0fa",botBubble:"#f1f1f1",userText:"#22223b",botText:"#4a4e69",background:"#fff",border:"#ccc",text:"#222",width:"100%",maxWidth:"350px",minWidth:"220px",borderRadius:"8px",fontFamily:"sans-serif",zIndex:9999,headerText:"#fff",headerBg:"rgba(34, 34, 59, 0.95)",inputBg:"#fff",inputText:"#222",sendBtnBg:"#0078d4",sendBtnText:"#fff",sendBtnHover:"#005fa3",shadow:"0 2px 8px rgba(0,0,0,0.15)",salesRepBubble:"#f1f5f9",salesRepText:"#475569",salesRepAvatar:"#E4E7FC",userAvatar:"#8349ff",botAvatar:"#E4E7FC",handoverNotificationBg:"#E4E7FC",handoverNotificationText:"#334155",handoverNotificationBorder:"#8349FF"}},t=window.SimpleChatEmbedConfig?{...e,...window.SimpleChatEmbedConfig,theme:{...e.theme,...window.SimpleChatEmbedConfig.theme||{}}}:e,n=t.theme,s=(t.apiUrl,t.welcomeMessage||null),o=t.workflowId,r=t.socketUrl+"/ws/chat/",l=null,a=!1,i=null,d=!1,c=!1;function y(){c?(x.style.opacity="0.5",x.style.cursor="not-allowed",v.style.opacity="0.5",v.style.cursor="not-allowed"):(x.style.opacity="1",x.style.cursor="pointer",v.style.opacity="1",v.style.cursor="pointer")}function m(e){const t=btoa(String(e)),n=new TextEncoder,s=n.encode("4f3c9a1d8e5b6c2f719a0e3d5a8b7c4d9e6f1a0b3d7c8e2f6a9d0e1b4c5f7a6d"),o=n.encode(t);return window.crypto.subtle.importKey("raw",s,{name:"HMAC",hash:"SHA-256"},!1,["sign"]).then((e=>window.crypto.subtle.sign("HMAC",e,o))).then((e=>{const n=Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("");return{hashed_workflow_id:t,hash:n}}))}function p(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)}))}var u=document.createElement("div");function f(){window.innerWidth<768?(u.style.position="fixed",u.style.top="0",u.style.left="0",u.style.right="0",u.style.bottom="0",u.style.width="100%",u.style.height="100vh",u.style.borderRadius="0",u.style.maxHeight="100vh"):(u.style.position="fixed",u.style.top="auto",u.style.left="auto",u.style.right="20px",u.style.bottom="20px",u.style.width="384px",u.style.height="80vh",u.style.borderRadius="0.75rem",u.style.maxHeight="600px")}u.id="simple-chat-embed",u.style.position="fixed",u.style.bottom="20px",u.style.right="20px",u.style.width="384px",u.style.height="80vh",u.style.maxHeight="600px",u.style.background="#ffffff",u.style.border="1px solid #e2e8f0",u.style.borderRadius="0.75rem",u.style.boxShadow="0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)",u.style.fontFamily=n.fontFamily+", Inter, system-ui, sans-serif",u.style.zIndex=n.zIndex,u.style.color=n.text,u.style.transition="transform 0.3s ease-in-out",u.style.display="flex",u.style.flexDirection="column",u.style.overflow="hidden",f(),window.addEventListener("resize",f);var h=document.createElement("div");h.style.display="flex",h.style.justifyContent="space-between",h.style.alignItems="center",h.style.background=n.headerBg||"#16a34a",h.style.color=n.headerText,h.style.padding="2rem",h.style.borderTopLeftRadius="0.75rem",h.style.borderTopRightRadius="0.75rem",h.style.fontWeight="600",h.style.fontSize="1.125rem",h.style.lineHeight="1.75rem";var g=document.createElement("div");g.innerText=t.title,h.appendChild(g);var b=document.createElement("div");b.style.display="flex",b.style.gap="0.25rem";var x=document.createElement("button");x.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="m21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M3 21v-5h5"/></svg>',x.title="Clear chat history",x.style.background="transparent",x.style.color=n.headerText,x.style.border="none",x.style.padding="0.5rem",x.style.cursor="pointer",x.style.borderRadius="0.375rem",x.style.display="flex",x.style.alignItems="center",x.style.justifyContent="center",x.style.transition="background-color 0.2s ease-in-out",x.onmouseover=function(){c||(x.style.backgroundColor="rgba(255,255,255,0.1)")},x.onmouseout=function(){x.style.backgroundColor="transparent"},x.onclick=function(){if(!c){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]").some((function(e){return e.isSystemNotification&&"joined"===e.notificationType})),t=localStorage.getItem("simple-chat-session"),n=!1;if(t)try{n=!0===JSON.parse(t).handoverOccurred}catch(e){console.log("Error reading session handover flag:",e)}localStorage.removeItem("simple-chat-messages"),d=!(!e&&!n),A(),s&&z(s,"bot","welcomeMessage"),W()}};var v=document.createElement("button");v.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>',v.title="Clear session & restart",v.style.background="transparent",v.style.color=n.headerText,v.style.border="none",v.style.padding="0.5rem",v.style.cursor="pointer",v.style.borderRadius="0.375rem",v.style.display="flex",v.style.alignItems="center",v.style.justifyContent="center",v.style.transition="background-color 0.2s ease-in-out",v.onmouseover=function(){c||(v.style.backgroundColor="rgba(255,255,255,0.1)")},v.onmouseout=function(){v.style.backgroundColor="transparent"},v.onclick=function(){c||(localStorage.removeItem("simple-chat-messages"),localStorage.removeItem("simple-chat-session"),localStorage.removeItem("simple-chat-leads"),localStorage.removeItem("simple-chat-user-guid"),d=!1,c=!1,window.__simpleChatEmbedLeadCaptured=!1,i=null,l&&(l.close(),l=null,a=!1),M.style.display="none",$((function(e){c=!1,y(),window.__simpleChatEmbedLeadCaptured=!0,e&&(window.SimpleChatEmbedLead=e),A(),s&&z(s,"bot","welcomeMessage"),W()})))};var w=document.createElement("button");w.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',w.title="Close chat",w.style.background="transparent",w.style.color=n.headerText,w.style.border="none",w.style.padding="0.5rem",w.style.cursor="pointer",w.style.borderRadius="0.375rem",w.style.display="flex",w.style.alignItems="center",w.style.justifyContent="center",w.style.transition="background-color 0.2s ease-in-out",w.onmouseover=function(){w.style.backgroundColor="rgba(255,255,255,0.1)"},w.onmouseout=function(){w.style.backgroundColor="transparent"};var k=w;b.appendChild(x),b.appendChild(v),b.appendChild(w),h.appendChild(b);var C=document.createElement("div");C.style.height="1px",C.style.background="#e2e8f0",C.style.marginBottom="1rem",u.appendChild(h),u.appendChild(C);var S=document.createElement("div");S.style.flex="1 1 0%",S.style.overflowY="auto",S.style.overflowX="hidden",S.style.padding="1rem",S.style.background="#ffffff",S.id="chat-messages",S.style.display="flex",S.style.flexDirection="column",S.style.gap="1rem",S.style.scrollBehavior="smooth",S.style.scrollbarWidth="none",S.style.msOverflowStyle="none";var E=document.createElement("style");E.textContent="\n        #chat-messages::-webkit-scrollbar { display: none; }\n        #simple-chat-embed ul { list-style-type: disc !important; }\n        #simple-chat-embed ol { list-style-type: decimal !important; }\n        #simple-chat-embed ul li::marker { color: #6b7280; }\n        #simple-chat-embed ol li::marker { color: #6b7280; font-weight: 600; }\n        #simple-chat-embed pre { white-space: pre-wrap; word-wrap: break-word; }\n        #simple-chat-embed code { word-wrap: break-word; }\n        #simple-chat-embed blockquote { \n            border-left: 4px solid #e5e7eb; \n            padding-left: 1rem; \n            margin: 1rem 0; \n            color: #6b7280; \n            font-style: italic; \n        }\n    ",document.head.appendChild(E),u.appendChild(S);var I=document.createElement("button");I.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m7 13 5 5 5-5"/><path d="M12 18V6"/></svg>',I.title="Scroll to bottom",I.style.position="absolute",I.style.right="1rem",I.style.bottom="5rem",I.style.width="40px",I.style.height="40px",I.style.borderRadius="50%",I.style.background=n.sendBtnBg||"#3b82f6",I.style.color="#ffffff",I.style.border="none",I.style.cursor="pointer",I.style.display="none",I.style.alignItems="center",I.style.justifyContent="center",I.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",I.style.transition="all 0.3s ease",I.style.zIndex="10",I.addEventListener("mouseover",(function(){I.style.backgroundColor=n.sendBtnHover||"#2563eb",I.style.transform="scale(1.1)"})),I.addEventListener("mouseout",(function(){I.style.backgroundColor=n.sendBtnBg||"#3b82f6",I.style.transform="scale(1)"})),I.onclick=function(){S.scrollTop=S.scrollHeight,I.style.display="none"},u.appendChild(I);var T=document.createElement("div");T.style.height="1px",T.style.background="#e2e8f0",T.style.marginTop="1rem";var M=document.createElement("div");M.style.padding="1rem",M.style.background="#ffffff",M.style.display="flex",M.style.flexDirection="column",M.style.borderBottomLeftRadius="0.75rem",M.style.borderBottomRightRadius="0.75rem",u.appendChild(T),u.appendChild(M);var L=document.createElement("div");L.style.display="grid",L.style.gridTemplateColumns="1fr auto",L.style.gap="1rem",L.style.alignItems="center",L.style.width="100%";var N=document.createElement("input");N.type="text",N.placeholder="Type your message...",N.style.padding="0.75rem 1rem",N.style.border="1px solid #d1d5db",N.style.borderRadius="0.375rem",N.style.background="#ffffff",N.style.color="#374151",N.style.fontSize="0.875rem",N.style.lineHeight="1.25rem",N.style.outline="none",N.style.transition="border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out",N.addEventListener("focus",(function(){N.style.borderColor="#3b82f6",N.style.boxShadow="0 0 0 3px rgba(59, 130, 246, 0.1)"})),N.addEventListener("blur",(function(){N.style.borderColor="#d1d5db",N.style.boxShadow="none"}));var B=document.createElement("button");function _(){var e=document.createElement("span");e.style.display="inline-flex",e.style.alignItems="center",e.style.height="1.5em";var t=n.botText||"#4a4e69";if(e.innerHTML=`\n      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s infinite alternate;"></span>\n      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.2s infinite alternate;"></span>\n      <span style="display:inline-block;width:8px;height:8px;margin:0 2px;background:${t};border-radius:50%;animation:bounce 1s 0.4s infinite alternate;"></span>\n    `,!document.getElementById("simple-chat-bounce-style")){var s=document.createElement("style");s.id="simple-chat-bounce-style",s.innerHTML="@keyframes bounce { 0% { transform: translateY(0); } 100% { transform: translateY(-7px); } }",document.head.appendChild(s)}return e}function H(e,t=!1){if(!e)return"";try{if("undefined"==typeof marked)throw new Error("marked.js not available");var s=marked.parse(e,{breaks:!0,gfm:!0});return"string"==typeof s?(s=s.replace(/<a\s+href="([^"]*)"([^>]*)>([^<]*)<\/a>/g,(function(e,t,s,o){return'<a href="'+t+'" target="_blank" style="font-weight:bold;color:'+(n.botText||"#4a4e69")+';text-decoration:underline;cursor:pointer;">'+o+"</a>"})),s=(s=(s=(s=(s=(s=(s=s.replace(/<ul>/g,'<ul style="margin:8px 0;padding-left:24px;">')).replace(/<ol>/g,'<ol style="margin:8px 0;padding-left:24px;">')).replace(/<li>/g,'<li style="margin:4px 0;">')).replace(/<pre><code>/g,"<pre style=\"background:#f6f8fa;border:1px solid #e1e4e8;border-radius:6px;padding:16px;margin:8px 0;overflow-x:auto;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:13px;line-height:1.45;\"><code>")).replace(/<code>/g,"<code style=\"background:#f6f8fa;border-radius:3px;padding:2px 4px;font-family:ui-monospace,SFMono-Regular,'SF Mono',Consolas,'Liberation Mono',Menlo,monospace;font-size:85%;\">")).replace(/<strong>/g,'<strong style="font-weight:600;">')).replace(/<em>/g,'<em style="font-style:italic;">')):String(s)}catch(t){return console.error("Markdown parsing error:",t),O(e).replace(/\n/g,"<br>")}}function O(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}function W(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");S.innerHTML="";var t,s=e.some((function(e){return e.isSystemNotification&&"joined"===e.notificationType}));s&&(d=!0);for(var o=0;o<e.length;o++){var r=e[o];if(r.isSystemNotification){var l=document.createElement("div");l.style.display="flex",l.style.justifyContent="center",l.style.margin="1rem 0",l.style.animation="fadeInUp 0.5s ease-out";var a=document.createElement("div");a.style.background="linear-gradient(135deg, #667eea 0%, #764ba2 100%)",a.style.color="#ffffff",a.style.padding="0.75rem 1.5rem",a.style.borderRadius="20px",a.style.fontSize="0.875rem",a.style.fontWeight="500",a.style.display="flex",a.style.alignItems="center",a.style.gap="0.5rem",a.style.maxWidth="80%",a.style.textAlign="center";var i=document.createElement("span");if("joined"===r.notificationType?(i.innerHTML="ðŸ‘‹",a.style.background=n.handoverNotificationBg||"#E4E7FC",a.style.color=n.handoverNotificationText||"#334155",a.style.border="1px solid "+(n.handoverNotificationBorder||"#8349FF")):i.innerHTML="ðŸ’¬",i.style.fontSize="1rem",a.appendChild(i),a.appendChild(document.createTextNode(r.text)),l.appendChild(a),!document.getElementById("system-notification-style")){var c=document.createElement("style");c.id="system-notification-style",c.innerHTML="\n                        @keyframes fadeInUp {\n                            0% { opacity: 0; transform: translateY(20px); }\n                            100% { opacity: 1; transform: translateY(0); }\n                        }\n                    ",document.head.appendChild(c)}S.appendChild(l)}else{var y=document.createElement("div");y.style.display="flex",y.style.flexDirection="column",y.style.marginBottom="1rem";var m=document.createElement("div");m.style.display="flex",m.style.gap="0.5rem","user"===r.sender&&(m.style.flexDirection="row-reverse",m.style.justifyContent="flex-start");var p=null;if("user"===r.sender){(p=document.createElement("div")).style.width="40px",p.style.height="40px",p.style.borderRadius="50%",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.style.background=n.userAvatar||"#8349ff";var u=document.createElement("div");u.innerHTML='\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <path d="M19 21V19C19 17.9391 18.5786 16.9217 17.8284 16.1716C17.0783 15.4214 16.0609 15 15 15H9C7.93913 15 6.92172 15.4214 6.17157 16.1716C5.42143 16.9217 5 17.9391 5 19V21" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                        <path d="M12 11C14.2091 11 16 9.20914 16 7C16 4.79086 14.2091 3 12 3C9.79086 3 8 4.79086 8 7C8 9.20914 9.79086 11 12 11Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                    </svg>\n                ',p.appendChild(u)}else if("sales_rep"===r.sender){(p=document.createElement("div")).style.width="40px",p.style.height="40px",p.style.borderRadius="50%",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.style.background=n.salesRepAvatar||"#E4E7FC";var f=n.primary||"#8349FF";p.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" style="width:26px;height:26px;color:'+f+';" width="200" height="200" viewBox="0 0 24 24"><path fill="currentColor" d="M19.938 8H21a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2h-1.062A8.001 8.001 0 0 1 12 23v-2a6 6 0 0 0 6-6V9A6 6 0 0 0 6 9v7H3a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h1.062a8.001 8.001 0 0 1 15.876 0ZM3 10v4h1v-4H3Zm17 0v4h1v-4h-1ZM7.76 15.785l1.06-1.696A5.972 5.972 0 0 0 12 15a5.972 5.972 0 0 0 3.18-.911l1.06 1.696A7.963 7.963 0 0 1 12 17a7.962 7.962 0 0 1-4.24-1.215Z"/></svg>'}else if("bot"===r.sender||"ai"===r.sender){(p=document.createElement("div")).style.width="40px",p.style.height="40px",p.style.borderRadius="50%",p.style.display="flex",p.style.alignItems="center",p.style.justifyContent="center",p.style.background=n.botAvatar||"#E4E7FC";var h=document.createElement("div");f=n.primary||"#8349ff";h.innerHTML=`\n                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">\n                        <g clip-path="url(#clip0_4_4929)">\n                            <path d="M19 11H5C3.89543 11 3 11.8954 3 13V19C3 20.1046 3.89543 21 5 21H19C20.1046 21 21 20.1046 21 19V13C21 11.8954 20.1046 11 19 11Z" stroke="${f}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            <path d="M12 7C13.1046 7 14 6.10457 14 5C14 3.89543 13.1046 3 12 3C10.8954 3 10 3.89543 10 5C10 6.10457 10.8954 7 12 7Z" stroke="${f}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                            <path d="M12 7V11" stroke="${f}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>\n                        </g>\n                        <defs>\n                            <clipPath id="clip0_4_4929">\n                                <rect width="24" height="24" fill="white"/>\n                            </clipPath>\n                        </defs>\n                    </svg>\n                `,p.appendChild(h)}var g=document.createElement("div");g.style.display="flex",g.style.flexDirection="column",g.style.gap="0.5rem",g.style.maxWidth=(r.sender,"70%");var b=document.createElement("div");if(b.style.padding="0.75rem 1rem",b.style.wordBreak="break-word",b.style.fontSize="0.875rem",b.style.lineHeight="1.25rem",b.style.position="relative","user"===r.sender?(b.style.backgroundColor=n.userBubble||"#dbeafe",b.style.color=n.userText||"#1e40af",b.style.alignSelf="flex-end",b.style.borderRadius="1rem 1rem 0.25rem 1rem",b.style.boxShadow="0 2px 8px rgba(59, 130, 246, 0.15)"):"sales_rep"===r.sender?(b.style.background=n.salesRepBubble||"#f1f5f9",b.style.color=n.salesRepText||"#475569",b.style.alignSelf="flex-start",b.style.borderRadius="1rem 1rem 1rem 0.25rem"):(b.style.backgroundColor=n.botBubble||"#f1f5f9",b.style.color=n.botText||"#475569",b.style.alignSelf="flex-start",b.style.borderRadius="1rem 1rem 1rem 0.25rem",b.style.boxShadow="0 2px 8px rgba(71, 85, 105, 0.1)"),""===r.text&&o===e.length-1)b.appendChild(_());else if("[Image]"===r.text&&o>0&&("string"==typeof(t=e[o-1].text)&&t.startsWith("data:image/"))){var x=document.createElement("img");x.src=e[o-1].text,x.style.maxWidth="200px",x.style.maxHeight="150px",x.style.borderRadius="0.5rem",x.style.display="block",b.appendChild(x)}else{var v=document.createElement("div");if("bot"===r.sender||"ai"===r.sender)v.innerHTML=H(r.text);else if("sales_rep"===r.sender){var w=O(r.text).replace(/\n/g,"<br>"),k="Sales Representative";r.senderName&&("string"==typeof r.senderName?k=r.senderName:r.senderName.name&&(k=r.senderName.name)),v.innerHTML='<div style=" padding-bottom: 6px; font-size: 0.75rem; color: #6b7280; font-weight: 500;">~ '+k+"</div>"+w,v.style.fontWeight="500",v.style.lineHeight="1.4",v.style.display="block",v.style.width="100%"}else v.innerHTML=O(r.text).replace(/\n/g,"<br>");b.appendChild(v)}if(g.appendChild(b),!r.isWelcomeMessage){var C=document.createElement("div");C.style.fontSize="0.75rem",C.style.color="#9ca3af",C.style.alignSelf="user"===r.sender?"flex-end":"flex-start",C.innerText=r.created_at,g.appendChild(C)}p&&m.appendChild(p),m.appendChild(g),y.appendChild(m),S.appendChild(y)}}S.scrollTop=S.scrollHeight,setTimeout((function(){S.scrollTop=S.scrollHeight,R()}),100)}function R(){var e=S.scrollHeight-S.scrollTop<=S.clientHeight+100;I.style.display=e?"none":"flex"}function j(){var e=0;!function t(){S.scrollTop=S.scrollHeight,++e<5&&S.scrollTop<S.scrollHeight-S.clientHeight-10?setTimeout(t,50):R()}()}function z(e,t,n=""){var s=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");if("welcomeMessage"===n){const n=s.findIndex((e=>e.isWelcomeMessage));-1!==n?s[n].text=e:s.push({text:e,isWelcomeMessage:!0,sender:t})}else s.push({text:e,isWelcomeMessage:!1,sender:t,created_at:D((new Date).toISOString())});localStorage.setItem("simple-chat-messages",JSON.stringify(s))}async function J(){if(!a&&!l){var e,t,n,s=localStorage.getItem("simple-chat-session");if(s)try{var c=JSON.parse(s),y=new Date-new Date(c.timestamp);if(!(c.chatID&&c.workflowId&&c.hashedWorkflowId&&c.hash&&c.visitorInfo&&y<864e5))throw new Error("Invalid or expired session");e=c.chatID,t=c.workflowId,n={hashed_workflow_id:c.hashedWorkflowId,hash:c.hash},i=c.visitorInfo}catch(e){console.log("Invalid session data, generating new session"),localStorage.removeItem("simple-chat-session"),s=null}if(!s&&(e=p(),t=o,n=await m(t),i)){var u={chatID:e,workflowId:t,hashedWorkflowId:n.hashed_workflow_id,hash:n.hash,visitorInfo:i,timestamp:(new Date).toISOString()};localStorage.setItem("simple-chat-session",JSON.stringify(u))}var f=`${r}${e}/?workflow_id=${n.hashed_workflow_id}&hash=${n.hash}&visitorInfo=${JSON.stringify(i)}`;try{(l=new WebSocket(f)).onopen=function(){a=!0},l.onmessage=function(e){var t=JSON.parse(e.data);if("unread_message"!==t?.message_type){if("handover_message"===t?.message_type){d=!0;var n=localStorage.getItem("simple-chat-session");if(n)try{var s=JSON.parse(n);s.handoverOccurred=!0,localStorage.setItem("simple-chat-session",JSON.stringify(s))}catch(e){console.log("Error updating session with handover flag:",e)}return(o=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:t.sender+" has entered the chat",sender:"system",isWelcomeMessage:!1,isSystemNotification:!0,notificationType:"joined",created_at:D(t.created_at||(new Date).toISOString())}),localStorage.setItem("simple-chat-messages",JSON.stringify(o)),void W()}if("ai"!==t.sender_type&&"ai"!==t.sender&&"bot"!==t.sender_type&&"bot"!==t.sender||d){if("sales_rep"===t.sender_type||"sales_rep"===t.sender){if(!(l=t.content||"")||!l.trim())return;(o=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]")).push({text:l,sender:t.sender_type,senderName:t.sender||t.sender_name||"Sales Representative",isWelcomeMessage:!1,created_at:D(t.created_at)}),localStorage.setItem("simple-chat-messages",JSON.stringify(o)),W()}}else{var o,r=(o=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"))[o.length-1];!r||""!==r.text||"bot"!==r.sender&&"ai"!==r.sender||(o.pop(),r=o[o.length-1]||null);var l=t.content||t.message||"";if(!0===t.is_complete&&""===l)return void(r&&r.isStreaming&&(console.log("Stream completed"),r.isStreaming=!1,o[o.length-1]=r,localStorage.setItem("simple-chat-messages",JSON.stringify(o))));l&&(!r||"bot"!==r.sender&&"ai"!==r.sender||!0!==r.isStreaming?o.push({text:l,sender:"bot",isWelcomeMessage:!1,isStreaming:!0,messageId:t.message_id,created_at:D(t.created_at),lastChunkTime:Date.now()}):(r.text+=l,r.lastChunkTime=Date.now(),o[o.length-1]=r),localStorage.setItem("simple-chat-messages",JSON.stringify(o)),W())}}},l.onclose=function(){console.error("WebSocket connection closed unexpectedly..."),a=!1,l=null},l.onerror=function(e){console.error("WebSocket error:",e),a=!1,l=null}}catch(e){console.error("Failed to create WebSocket connection:",e),a=!1,l=null}}}function D(e){return new Date(e).toLocaleTimeString("en-US",{hour:"2-digit",minute:"2-digit",hour12:!0})}function F(e){var t=N.value.trim()||e;if(t)if(z(t,"user"),N.value="",W(),d||(z("","bot"),W()),a&&l&&l.readyState===WebSocket.OPEN)try{l.send(JSON.stringify({message:t,message_type:"text"}))}catch(e){console.error("Error sending message:",e);var n=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");n.length>0&&""===n[n.length-1].text&&n.pop(),n.push({text:"Error sending message. Please try again.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(n)),W()}else{J();var s=function(){if(l&&l.readyState===WebSocket.OPEN)l.send(JSON.stringify({message:t,message_type:"text"}));else if(l&&l.readyState===WebSocket.CONNECTING)setTimeout(s,100);else{var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");e.length>0&&""===e[e.length-1].text&&e.pop(),e.push({text:"Error: Could not connect to chat service.",sender:"bot",isWelcomeMessage:!1}),localStorage.setItem("simple-chat-messages",JSON.stringify(e)),W()}};setTimeout(s,500)}}function $(e){c=!0,y(),S.innerHTML="";var t=document.createElement("div");t.style.display="flex",t.style.flexDirection="column",t.style.alignItems="center",t.style.justifyContent="center",t.style.height="100%",t.style.width="100%",t.style.gap="1.5rem";var s=document.createElement("div");s.style.width="100%",s.style.maxWidth="300px",s.style.display="flex",s.style.flexDirection="column",s.style.gap="1.5rem";var r=document.createElement("div");r.style.display="flex",r.style.flexDirection="column",r.style.gap="0.5rem";var l=document.createElement("div");l.style.display="flex",l.style.alignItems="center",l.style.gap="1.5rem";var a=document.createElement("label");a.innerText="Full Name:*",a.style.width="27%",a.style.fontSize="0.875rem",a.style.fontWeight="500",a.style.color="#374151";var d=document.createElement("input");d.type="text",d.placeholder="Full name",d.style.width="60%",d.style.padding="0.75rem 1rem",d.style.border="1px solid #d1d5db",d.style.borderRadius="0.375rem",d.style.fontSize="0.875rem",d.style.outline="none",d.style.transition="border-color 0.2s ease-in-out",d.addEventListener("focus",(function(){d.style.borderColor="#3b82f6"})),d.addEventListener("blur",(function(){d.style.borderColor="#d1d5db"})),l.appendChild(a),l.appendChild(d);var u=document.createElement("div");u.style.display="none",u.style.color="#ef4444",u.style.fontSize="0.75rem",u.style.marginLeft="27%",u.style.paddingLeft="1.5rem",u.innerText="Full name is required",r.appendChild(l),r.appendChild(u);var f=document.createElement("div");f.style.display="flex",f.style.flexDirection="column",f.style.gap="0.5rem";var h=document.createElement("div");h.style.display="flex",h.style.alignItems="center",h.style.gap="1.5rem";var g=document.createElement("label");g.innerText="Email:*",g.style.width="27%",g.style.fontSize="0.875rem",g.style.fontWeight="500",g.style.color="#374151";var b=document.createElement("input");b.type="email",b.placeholder="Email",b.style.width="60%",b.style.padding="0.75rem 1rem",b.style.border="1px solid #d1d5db",b.style.borderRadius="0.375rem",b.style.fontSize="0.875rem",b.style.outline="none",b.style.transition="border-color 0.2s ease-in-out",b.addEventListener("focus",(function(){b.style.borderColor="#3b82f6"})),b.addEventListener("blur",(function(){b.style.borderColor="#d1d5db"})),h.appendChild(g),h.appendChild(b);var x=document.createElement("div");x.style.display="none",x.style.color="#ef4444",x.style.fontSize="0.75rem",x.style.marginLeft="27%",x.style.paddingLeft="1.5rem",x.innerText="Please enter a valid email address",f.appendChild(h),f.appendChild(x);var v=document.createElement("div");v.style.display="flex",v.style.flexDirection="column",v.style.gap="0.5rem";var w=document.createElement("div");w.style.display="flex",w.style.alignItems="center",w.style.gap="1.5rem";var k=document.createElement("label");k.innerText="Phone:*",k.style.width="27%",k.style.fontSize="0.875rem",k.style.fontWeight="500",k.style.color="#374151";var C=document.createElement("input");C.type="tel",C.placeholder="Phone number",C.maxLength=20,C.style.width="60%",C.style.padding="0.75rem 1rem",C.style.border="1px solid #d1d5db",C.style.borderRadius="0.375rem",C.style.fontSize="0.875rem",C.style.outline="none",C.style.transition="border-color 0.2s ease-in-out",C.addEventListener("focus",(function(){C.style.borderColor="#3b82f6"})),C.addEventListener("blur",(function(){C.style.borderColor="#d1d5db"})),w.appendChild(k),w.appendChild(C);var E=document.createElement("div");E.style.display="none",E.style.color="#ef4444",E.style.fontSize="0.75rem",E.style.marginLeft="27%",E.style.paddingLeft="1.5rem",E.innerText="Phone number is required",v.appendChild(w),v.appendChild(E),s.appendChild(r),s.appendChild(f),s.appendChild(v);var I=document.createElement("button");I.innerText="Start Chat",I.style.width="100%",I.style.maxWidth="300px",I.style.padding="0.75rem 1.5rem",I.style.background=n.sendBtnBg||"#16a34a",I.style.color="#ffffff",I.style.border="none",I.style.borderRadius="0.375rem",I.style.cursor="pointer",I.style.fontWeight="600",I.style.fontSize="0.875rem",I.style.transition="background-color 0.2s ease-in-out",I.addEventListener("mouseover",(function(){I.style.backgroundColor=n.sendBtnHover||"#15803d"})),I.addEventListener("mouseout",(function(){I.style.backgroundColor=n.sendBtnBg||"#16a34a"})),I.onclick=async function(){var t=d.value.trim(),n=b.value.trim(),s=C.value.trim(),r=!1;if(d.style.borderColor="#d1d5db",b.style.borderColor="#d1d5db",C.style.borderColor="#d1d5db",u.style.display="none",x.style.display="none",E.style.display="none",t||(d.style.borderColor="#ef4444",u.style.display="block",r=!0),n?/^\S+@\S+\.\S+$/.test(n)||(b.style.borderColor="#ef4444",x.innerText="Please enter a valid email address",x.style.display="block",r=!0):(b.style.borderColor="#ef4444",x.innerText="Email is required",x.style.display="block",r=!0),s?s.length>20?(C.style.borderColor="#ef4444",E.innerText="Phone number must be 20 characters or less",E.style.display="block",r=!0):/^[\+]?[0-9\s\-\(\)\.]{1,20}$/.test(s)||(C.style.borderColor="#ef4444",E.innerText="Please enter a valid phone number",E.style.display="block",r=!0):(C.style.borderColor="#ef4444",E.innerText="Phone number is required",E.style.display="block",r=!0),r)t?n&&/^\S+@\S+\.\S+$/.test(n)?(!s||s.length>20||!/^[\+]?[0-9\s\-\(\)\.]{1,20}$/.test(s))&&C.focus():b.focus():d.focus();else{S.innerHTML="",await q(P(d.value),P(b.value),P(C.value));var l=p(),a=o,c=await m(a),y={chatID:l,workflowId:a,hashedWorkflowId:c.hashed_workflow_id,hash:c.hash,visitorInfo:i,timestamp:(new Date).toISOString()};localStorage.setItem("simple-chat-session",JSON.stringify(y));var f=navigator.userAgent,h=navigator.platform,g=window.location.href,v=(new Date).toISOString(),w=navigator.language,k=document.referrer,I={name:P(d.value),email:P(b.value),phone:P(C.value),timestamp:v,userAgent:f,platform:h,url:g,language:w,referrer:k,ip:""},T=JSON.parse(localStorage.getItem("simple-chat-leads")||"[]");T.push(I),localStorage.setItem("simple-chat-leads",JSON.stringify(T)),e(I),F(`${d.value} ${b.value} ${C.value}`)}},d.addEventListener("keydown",(function(e){"Enter"===e.key&&I.click()})),b.addEventListener("keydown",(function(e){"Enter"===e.key&&I.click()})),C.addEventListener("keydown",(function(e){"Enter"===e.key&&I.click()})),t.appendChild(s),t.appendChild(I),S.appendChild(t),d.focus()}function A(){M.style.display="flex",M.style.flexDirection="row",M.style.width="100%",M.style.boxSizing="border-box",M.style.padding="0.5rem",M.style.gap="0",M.style.alignItems="stretch",M.style.flex="0 0 auto",M.style.borderTop="1px solid #ececec",M.style.background="#ffffff",N.style.flex="1 1 0%",N.style.minWidth="0",N.style.width="auto",N.style.margin="0",N.style.height="2.5rem",N.style.padding="0 1rem",N.style.border="1px solid #ececec",N.style.borderRight="none",N.style.borderRadius="0.75rem 0 0 0.75rem",N.style.background=n.inputBg,N.style.color=n.inputText,N.style.fontSize="1rem",N.style.boxSizing="border-box",N.style.outline="none",N.style.transition="border 0.15s ease-in-out",B.style.flex="0 0 auto",B.style.margin="0",B.style.height="2.5rem",B.style.padding="0 1.25rem",B.style.background=n.sendBtnBg,B.style.color=n.sendBtnText,B.style.border="1px solid #ececec",B.style.borderLeft="none",B.style.borderRadius="0 0.75rem 0.75rem 0",B.style.cursor="pointer",B.style.fontWeight="600",B.style.fontSize="1rem",B.style.transition="background 0.15s ease-in-out, color 0.15s ease-in-out",B.style.boxSizing="border-box",B.style.display="flex",B.style.justifyContent="center",B.style.alignItems="center"}function P(e){return String(e).replace(/[&<>"']/g,(function(e){return{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]}))}B.title="Send",B.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>',B.style.padding="0.75rem",B.style.background=n.sendBtnBg||"#3b82f6",B.style.color="#ffffff",B.style.border="none",B.style.borderRadius="0.375rem",B.style.cursor="pointer",B.style.display="flex",B.style.alignItems="center",B.style.justifyContent="center",B.style.transition="background-color 0.2s ease-in-out",B.addEventListener("mouseover",(function(){B.style.backgroundColor=n.sendBtnHover||"#2563eb"})),B.addEventListener("mouseout",(function(){B.style.backgroundColor=n.sendBtnBg||"#3b82f6"})),L.appendChild(N),L.appendChild(B),M.appendChild(L),u.appendChild(M),document.body.appendChild(u),S.addEventListener("scroll",(function(){R()})),B.onclick=F,N.addEventListener("keydown",(function(e){"Enter"===e.key&&F()}));var V=document.createElement("button");function Z(){window.innerWidth,V.style.bottom="20px",V.style.right="20px"}V.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="34" height="34" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle-icon lucide-message-circle"><path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/></svg>',V.style.position="fixed",V.style.bottom="20px",V.style.right="20px",V.style.width="80px",V.style.height="80px",V.style.borderRadius="50%",V.style.backgroundColor=n.sendBtnBg||"#16a34a",V.style.color="#ffffff",V.style.border="none",V.style.cursor="pointer",V.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.15)",V.style.display="flex",V.style.alignItems="center",V.style.justifyContent="center",V.style.transition="all 0.3s ease",V.style.zIndex=n.zIndex-1,Z(),window.addEventListener("resize",Z),u.style.display="none";var U=!1;V.addEventListener("click",(function(){(U=!U)?(u.style.display="flex",V.style.display="none",setTimeout((function(){j()}),150)):(u.style.display="none",V.style.display="flex")})),k.onclick=function(){U=!1,u.style.display="none",V.style.display="flex"},document.body.appendChild(V),window.saveMessage=z,window.loadMessages=W,window.generateChatId=p,window.generateSecureWsParams=m,window.connectWebSocket=J;const q=async(e,n,s)=>{try{var o=null,r=null;"wss://hub.memox.io"===t.socketUrl?(o="https://hub.memox.io/api/v1/",r="eedb5fc2b457815409e45f3b1dc023c276c9cedb"):(o="http://localhost:8000/api/v1/",r="cbacbe059689c3dec8173c05d806c7266b50176e");const l=await fetch(`${o}visitors/?email=${n}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Token ${r} `}}),a=await l.json();if("Not found."!==a.detail&&a.length)i={id:a[0].id,name:a[0].name};else{const t=await fetch(`${o}visitors/`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Token ${r} `},body:JSON.stringify({name:e,email:n,phone_number:s})});if(!t.ok)throw new Error(`Failed to create visitor: ${t.status}`);const l=await t.json();i={id:l.id,name:l.name}}}catch(t){console.error("Error creating/fetching visitor:",t),i={id:"offline_"+Date.now(),name:e}}};!function(){var e=JSON.parse(localStorage.getItem("simple-chat-messages")||"[]"),t=localStorage.getItem("simple-chat-session");if(e.length>0&&t){window.__simpleChatEmbedLeadCaptured=!0;try{var n=JSON.parse(t);i=n.visitorInfo,!0===n.handoverOccurred&&(d=!0)}catch(e){console.log("Error parsing session data:",e)}return A(),W(),setTimeout((function(){j()}),200),void J()}window.__simpleChatEmbedLeadCaptured?(A(),W()):(M.style.display="none",$((function(e){c=!1,y(),window.__simpleChatEmbedLeadCaptured=!0,e&&(window.SimpleChatEmbedLead=e),A();JSON.parse(localStorage.getItem("simple-chat-messages")||"[]");s&&z(s,"bot","welcomeMessage"),W()})))}(),setTimeout((function(){var e=localStorage.getItem("simple-chat-session");if(e)try{var t=JSON.parse(e),n=new Date-new Date(t.timestamp);t.chatID&&t.workflowId&&t.hashedWorkflowId&&t.hash&&t.visitorInfo&&n<864e5&&(i=t.visitorInfo,a||l||J())}catch(e){console.log("Error checking stored session for auto-connect:",e)}}),100)}t()}();